(window.webpackJsonp=window.webpackJsonp||[]).push([[32],{395:function(s,a,t){"use strict";t.r(a);var p=t(11),n=Object(p.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"uploadlabs11-20"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#uploadlabs11-20"}},[s._v("#")]),s._v(" uploadlabs11-20")]),s._v(" "),a("p",[s._v("pass11-pass12补充：")]),s._v(" "),a("ul",[a("li",[s._v("GET路径会自动解析")]),s._v(" "),a("li",[s._v("POST路径不会自动解析")])]),s._v(" "),a("h2",{attrs:{id:"pass-11-白名单绕过"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#pass-11-白名单绕过"}},[s._v("#")]),s._v(" pass-11 白名单绕过")]),s._v(" "),a("p",[s._v("查看源码，保存路径是由GET[save_path]定义，可控")]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/upload11-20/1-0.jpeg",alt:"1-0"}})]),s._v(" "),a("p",[s._v("上传白名单png/gif/jpg类型文件，打开bp抓包，修改get的保存路径，使用 "),a("strong",[s._v("%00")]),s._v(" 截断，"),a("strong",[s._v("在路径中，出现%00会舍弃后面内容，例如在此题上传文件时，最终保存结果应该为/upload/1.png，但是通过修改路径，使他保存在/upload/1.php/路径下，后面没有内容，文件名最终变成1.php，作为php文件解析")])]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/upload11-20/1-1.jpeg",alt:"1-1"}})]),s._v(" "),a("p",[s._v("访问upload/1.php,解析成功")]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/upload11-20/1-3.jpg",alt:"1-3"}})]),s._v(" "),a("h2",{attrs:{id:"pass-12"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#pass-12"}},[s._v("#")]),s._v(" pass-12")]),s._v(" "),a("p",[s._v("查看源码，使用post定义保存路径，可控")]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/upload11-20/2-1.png",alt:"2-1"}})]),s._v(" "),a("p",[s._v("上传白名单文件，bp抓包，修改post路径，同样使用 "),a("strong",[s._v("%00")]),s._v(" 截断路径名称，但是此时是post传参，%00不会自动解析，选中%00右键url解析")]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/upload11-20/2-2.png",alt:"2-2"}})]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/upload11-20/2-3.jpg",alt:"2-3"}})]),s._v(" "),a("p",[s._v("发包，访问'图片'地址，成功解析")]),s._v(" "),a("p",[s._v("pass13-pass16补充")]),s._v(" "),a("p",[s._v("服务器设置白名单，只允许图片类型文件上传时，如果有include包含漏洞，可以"),a("strong",[s._v("将图片马/其他文件类型作为php文件解析")])]),s._v(" "),a("h2",{attrs:{id:"pass-13"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#pass-13"}},[s._v("#")]),s._v(" pass-13")]),s._v(" "),a("p",[s._v("提示包含漏洞，访问include.php能否访问")]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/upload11-20/3-1.jpg",alt:"3-1"}})]),s._v(" "),a("p",[s._v("看到include.php可以通过get传参利用")]),s._v(" "),a("p",[s._v("查看源码，会读取上传文件前两个字节内容，是否属于白名单里的文件类型，上传图片马，通过http://localhost/include.php?file=你的图片马文件名访问，成功解析")]),s._v(" "),a("h2",{attrs:{id:"pass-14"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#pass-14"}},[s._v("#")]),s._v(" pass-14")]),s._v(" "),a("p",[s._v("查看源码，**getimagesize($filename)**中getimagesize()函数会读取上传文件的头文件是否是图片类型，仍然使用图片马和include包含漏洞上传文件")]),s._v(" "),a("h2",{attrs:{id:"pass-15"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#pass-15"}},[s._v("#")]),s._v(" pass-15")]),s._v(" "),a("p",[s._v("查看源码，**exif_imagetype($filename)**中exif_imagetype()函数也是检查上传文件是否符合要求，做法同上")]),s._v(" "),a("h2",{attrs:{id:"pass-16"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#pass-16"}},[s._v("#")]),s._v(" pass-16")]),s._v(" "),a("p",[s._v("略")]),s._v(" "),a("h2",{attrs:{id:"pass-17"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#pass-17"}},[s._v("#")]),s._v(" pass-17")]),s._v(" "),a("p",[s._v("学到了两个方法")]),s._v(" "),a("p",[s._v("法1：(不太正经)")]),s._v(" "),a("p",[s._v("查看源码，使用了move_uploaded_file()函数，这个函数遇到文件名为 "),a("strong",[s._v("/.")]),s._v(" 时，会舍弃**/.及后面内容**")]),s._v(" "),a("p",[s._v("上传php文件，bp抓包修改文件名例如1.php/.png，随后上传成功，复制图片路径，使用文件包含访问")]),s._v(" "),a("p",[s._v("法2：")]),s._v(" "),a("p",[s._v("题目先接收文件，再做检查，再服务器检查之前如果能访问(打开)到这个文件，服务器就删不掉了，从而获取权限")]),s._v(" "),a("p",[s._v("解法，使用bp不断发包，但是我的bp出了问题，只发一次...借鉴大佬python脚本跑，脚本实现发包并访问，")]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/upload11-20/7-1.jpg",alt:"7-1"}})]),s._v(" "),a("p",[s._v("代码如下")]),s._v(" "),a("div",{staticClass:"language-python line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# coding:utf-8")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" requests\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" concurrent"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("futures "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" ThreadPoolExecutor\n \n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("td")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("list")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    url "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'http://localhost/Pass-17/index.php?action=show_code'")]),s._v("\n    files "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'upload_file'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'szm.png'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"<?php fputs(fopen('shell.php','w'),'<?php phpinfo();  ?>' ); ?>\"")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n       \n    data "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'submit'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'上传'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    r "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" requests"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("post"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("url"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("url"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" data"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" files"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("files"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    re "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" requests"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("get"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'http://localhost/include.php?file=upload/szm.png'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" re"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("status_code "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'上传成功'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n \n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" __name__ "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'__main__'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("with")]),s._v(" ThreadPoolExecutor"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" p"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        p"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("map")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("td"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("range")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br")])]),a("p",[s._v("上传php文件，访问这个php文件，访问成功即可连接")]),s._v(" "),a("p",[s._v("上传图片马，配合include.php时，注意上传路径")]),s._v(" "),a("h2",{attrs:{id:"pass-18"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#pass-18"}},[s._v("#")]),s._v(" pass-18")]),s._v(" "),a("p",[s._v("使用"),a("strong",[s._v("pass-18")]),s._v("图片马解法")]),s._v(" "),a("h2",{attrs:{id:"pass-19"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#pass-19"}},[s._v("#")]),s._v(" pass-19")]),s._v(" "),a("p",[s._v("两种解法")]),s._v(" "),a("p",[s._v("法1：")]),s._v(" "),a("p",[s._v("查看源码，黑名单验证，先检查扩展名，使用png绕过，使用post接收上传地址，地址可控")]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/upload11-20/9-1.jpg",alt:"9-1"}})]),s._v(" "),a("p",[s._v("bp抓包，修改上传地址")]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/upload11-20/9-2.jpg",alt:"9-2"}})]),s._v(" "),a("p",[s._v("注意post传参的地址不会url编码，%00右键编码，上传，复制图片地址即可访问")]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/upload11-20/9-3.jpg",alt:"9-3"}})]),s._v(" "),a("h2",{attrs:{id:"pass-20"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#pass-20"}},[s._v("#")]),s._v(" pass-20")]),s._v(" "),a("p",[s._v("查看源码")]),s._v(" "),a("ul",[a("li",[s._v("检查文件MIME内容是否属于图片类型")]),s._v(" "),a("li",[s._v("检查文件名是否为空")]),s._v(" "),a("li",[s._v("文件名是否属于数组")])]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/upload11-20/10-1.jpg",alt:"10-1"}})]),s._v(" "),a("p",[s._v("先接着获取最后面的扩展名，此时需要传入两个save_name[0]，save_name[2]，0存放2.php/.利用move_uploaded_file特性舍弃后面，2存放png")]),s._v(" "),a("p",[s._v("再看源码，取数组名(数组第一个)作为文件名，会将文件名数组最后一个作为扩展名，")]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/upload11-20/10-3.jpg",alt:"10-3"}})]),s._v(" "),a("p",[s._v("bp抓包，将文件MIME改为图片类型，save_name[]改为数组")]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/upload11-20/10-2.jpg",alt:"10-1"}})]),s._v(" "),a("p",[s._v("上传访问")])])}),[],!1,null,null,null);a.default=n.exports}}]);