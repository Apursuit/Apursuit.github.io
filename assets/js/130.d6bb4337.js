(window.webpackJsonp=window.webpackJsonp||[]).push([[130],{488:function(s,a,t){"use strict";t.r(a);var e=t(8),r=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("p",[s._v("在入口机上线Meterpreter后，把入口机作为跳板机，通过添加路由、端口转发、socks代理等多种方式访问内网")]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/msfproxy/1.png",alt:""}})]),s._v(" "),a("h2",{attrs:{id:"描述"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#描述"}},[s._v("#")]),s._v(" 描述")]),s._v(" "),a("p",[s._v("例如上图中所示拓扑，192.168.10.x网段的攻击机无法直接访问192.168.20.x网段内网主机，入口机存在192.168.10.x、192.168.20.x两个网卡，在拿下入口机meterpreter后，让这台入口机转发流量实现访问内网")]),s._v(" "),a("p",[s._v("metasploit内网代理的三种方式：")]),s._v(" "),a("ul",[a("li",[s._v("添加路由")]),s._v(" "),a("li",[s._v("端口转发")]),s._v(" "),a("li",[s._v("socks代理")])]),s._v(" "),a("h2",{attrs:{id:"autoroute添加路由"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#autoroute添加路由"}},[s._v("#")]),s._v(" autoroute添加路由")]),s._v(" "),a("p",[s._v("在入口机添加静态路由，让攻击机知道如何访问内网，添加路由后，msf的流量会自动分流，其他流量不受影响")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("meterpreter "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" run autoroute "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-s")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".20.0/24\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("或者在msfconsole中使用，指定session id")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("msf "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" route "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".20.0 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("255.255")]),s._v(".255.0 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("删除路由指令")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("msf "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" route remove "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".20.0 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("255.255")]),s._v(".255.0 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("提示")]),s._v(" "),a("p",[s._v("添加路由后，攻击机可以通过入口机转发流量访问内网，在内网主机存在漏洞可以利用时，推荐使用"),a("strong",[s._v("正向shell")]),s._v("，如果使用反弹shell，内网主机没有到攻击机的路由，反弹shell会失败。可以通过portfwd把本地监听端口映射到入口机上，反弹shell到入口机的映射端口。")])]),s._v(" "),a("h2",{attrs:{id:"portfwd端口转发"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#portfwd端口转发"}},[s._v("#")]),s._v(" portfwd端口转发")]),s._v(" "),a("p",[s._v("效果可能较差，流量经过了多次转发")]),s._v(" "),a("p",[s._v("在入口机上使用portfwd命令做端口转发，把内网主机的端口映射到本地（攻击机）上，访问本地端口实现直接访问内网主机的效果")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("meterpreter "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" portfwd "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-l")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10000")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-r")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".20.20\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ul",[a("li",[s._v("l：本地端口（使用msf的主机）")]),s._v(" "),a("li",[s._v("p：内网主机端口")]),s._v(" "),a("li",[s._v("r：内网主机IP")])]),s._v(" "),a("p",[s._v("例如192.168.20.20主机存在一个thinkphp漏洞版本，通过这条命令把内网主机8080端口映射到攻击机10000端口，可以直接访问127.0.0.1:10000达到访问192.168.20.20:8080的效果")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("meterpreter "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" portfwd list\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  Local         Remote                Direction")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:3389  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".10.20:3389   Forward\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:445   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".10.30:445    Forward\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 方法一：根据id删除")]),s._v("\nmeterpreter "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" portfwd delete "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 方法二：根据本地端口删除")]),s._v("\nmeterpreter "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" portfwd delete "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-l")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3389")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("反向端口转发。把本地的端口映射到入口机上，内网主机可以通过入口机访问")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("portfwd "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-R")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1389")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-L")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".10.10 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-l")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1389")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h2",{attrs:{id:"socks代理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#socks代理"}},[s._v("#")]),s._v(" socks代理")]),s._v(" "),a("p",[s._v("启动 SOCKS5 代理模块，需要先使用route命令添加路由")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("msf6 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" use auxiliary/server/socks_proxy\nmsf6 auxiliary"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("server/socks_proxy"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" VERSION "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("\nVERSION "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("\nmsf6 auxiliary"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("server/socks_proxy"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" SRVHOST "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0\nSRVHOST "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0\nmsf6 auxiliary"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("server/socks_proxy"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" SRVPORT "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1080")]),s._v("\nSRVPORT "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1080")]),s._v("\nmsf6 auxiliary"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("server/socks_proxy"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" run\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("h2",{attrs:{id:"使用socks5代理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用socks5代理"}},[s._v("#")]),s._v(" 使用socks5代理")]),s._v(" "),a("p",[s._v("可以在浏览器里配置socks5代理，或使用proxifier等工具，让流量走代理访问内网")]),s._v(" "),a("p",[s._v("浏览器使用扩展"),a("a",{attrs:{href:"https://microsoftedge.microsoft.com/addons/detail/proxy-switchyomega-3-zer/dmaldhchmoafliphkijbfhaomcgglmgd",target:"_blank",rel:"noopener noreferrer"}},[s._v("Proxy SwitchyOmega 3 (ZeroOmega)"),a("OutboundLink")],1)]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/msfproxy/2.png",alt:""}})]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/msfproxy/3.png",alt:""}})]),s._v(" "),a("p",[s._v("访问内网资源使用这个socks5代理")]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/msfproxy/4.png",alt:""}})]),s._v(" "),a("p",[s._v("使用proxifier让你的工具都能访问内网")]),s._v(" "),a("p",[s._v("proxifier添加代理服务器")]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/msfproxy/5.png",alt:""}})]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/msfproxy/6.png",alt:""}})]),s._v(" "),a("p",[s._v("配置后，指定的exe工具就可以使用socks5代理访问内网。例如python脚本、java的jar工具，你添加运行时的python.exe、java.exe即可")]),s._v(" "),a("p",[s._v("自用")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("run autoroute "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-s")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".20.0/24\nportfwd "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-l")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10000")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-r")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".20.20\nuse auxiliary/server/socks_proxy\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" VERSION "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" SRVHOST "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" SRVPORT "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1080")]),s._v("\nrun\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("参考：")]),s._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://blog.csdn.net/u014029795/article/details/117375754",target:"_blank",rel:"noopener noreferrer"}},[s._v("内网渗透-msf及socks代理转发"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://pingmaoer.github.io/2020/05/09/%E5%88%A9%E7%94%A8msf%E8%87%AA%E5%B8%A6%E7%9A%84route%E6%A8%A1%E5%9D%97%E7%A9%BF%E9%80%8F%E7%9B%AE%E6%A0%87%E5%86%85%E7%BD%91/",target:"_blank",rel:"noopener noreferrer"}},[s._v("利用msf自带的route模块穿透目标内网"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://blog.csdn.net/qq_42342141/article/details/107113750",target:"_blank",rel:"noopener noreferrer"}},[s._v("利用Metasploit Framework（msf）进行内网（域）渗透"),a("OutboundLink")],1)])])])}),[],!1,null,null,null);a.default=r.exports}}]);