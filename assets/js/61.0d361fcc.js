(window.webpackJsonp=window.webpackJsonp||[]).push([[61],{417:function(t,a,s){"use strict";s.r(a);var e=s(8),v=Object(e.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h2",{attrs:{id:"_1-漏洞描述"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-漏洞描述"}},[t._v("#")]),t._v(" 1. 漏洞描述")]),t._v(" "),a("ul",[a("li",[t._v("漏洞编号：CVE-2017-12615")]),t._v(" "),a("li",[t._v("影响版本范围：Apache Tomcat 7.0.0 - 7.0.79（？）")]),t._v(" "),a("li",[t._v("影响平台：Windows、linux")]),t._v(" "),a("li",[t._v("漏洞类型：不安全的配置、任意文件上传、RCE")])]),t._v(" "),a("h2",{attrs:{id:"_2-漏洞原理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-漏洞原理"}},[t._v("#")]),t._v(" 2. 漏洞原理")]),t._v(" "),a("p",[t._v("Tomcat默认配置中，"),a("code",[t._v("conf/web.xml")]),t._v("文件里没有配置对应"),a("code",[t._v("PUT")]),t._v("请求的处理，所以默认情况下，Tomcat是不处理"),a("code",[t._v("PUT")]),t._v("请求的。如果在"),a("code",[t._v("web.xml")]),t._v("文件里自行添加了"),a("code",[t._v("readonly")]),t._v("参数的false值，就添加了"),a("code",[t._v("PUT")]),t._v("请求的处理")]),t._v(" "),a("p",[t._v("该参数默认为true，"),a("code",[t._v("只读状态")]),t._v("：不允许用户put方法写入文件")]),t._v(" "),a("p",[t._v("开启后，put请求类似一个上传接口，把文件储存在默认的网站根目录"),a("code",[t._v("webapps/ROOT")]),t._v("下，并且文件名和文件内容都可控")]),t._v(" "),a("p",[t._v("总结：不安全的参数配置导致的文件上传漏洞，在上传jsp后，可以RCE，getshell")]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("补充")]),t._v(" "),a("p",[t._v("tomcat对文件扩展名有一定检测，不能直接上传jsp文件，可以通过一些姿势绕过")])]),t._v(" "),a("h2",{attrs:{id:"_3-windows环境漏洞复现"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-windows环境漏洞复现"}},[t._v("#")]),t._v(" 3. windows环境漏洞复现")]),t._v(" "),a("p",[t._v("看了一些其他师傅博客，很多都指出只会影响windows平台，两个都试试了")]),t._v(" "),a("h3",{attrs:{id:"_3-0-补充"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-0-补充"}},[t._v("#")]),t._v(" 3.0 补充")]),t._v(" "),a("p",[t._v("复现过程一些tomcat目录的作用")]),t._v(" "),a("div",{staticClass:"language-plaintext line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plaintext"}},[a("code",[t._v("- bin\n    - startup.bat  # 启动tomcat\n    - shutdown.bat  # 关闭tomcat\n- conf\n    - web.xml  # tomcat参数配置文件\n    - server.xml  # tomcat服务器配置文件\n- webapps\n    - ROOT  # 网站根目录\n        - index.html  # 默认首页\n        - WEB-INF  # \n            - web.xml  # 网站参数配置文件\n- logs  # tomcat日志目录\n    - localhost_access_log.2025-05-13.txt  # tomcat访问日志\n    - localhost.2025-05-13.log  # tomcat错误日志\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br")])]),a("p",[a("code",[t._v("PUT")]),t._v(" 方法的原意是："),a("strong",[t._v("“把某个资源上传到服务端的指定 URI 处，如果不存在就创建，如果存在就替换”")])]),t._v(" "),a("h3",{attrs:{id:"_3-1-环境搭建"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-环境搭建"}},[t._v("#")]),t._v(" 3.1 环境搭建")]),t._v(" "),a("p",[t._v("漏洞环境：")]),t._v(" "),a("ul",[a("li",[t._v("windows10")]),t._v(" "),a("li",[t._v("tomcat 7.0.79")]),t._v(" "),a("li",[t._v("jdk 1.8")]),t._v(" "),a("li",[t._v("burpsuite")])]),t._v(" "),a("p",[t._v("下载windows x64 tomcat 7.0.79，解压。下载链接"),a("a",{attrs:{href:"https://archive.apache.org/dist/tomcat/tomcat-7/v7.0.79/bin/apache-tomcat-7.0.79-windows-x64.zip",target:"_blank",rel:"noopener noreferrer"}},[t._v("apache-tomcat-7.0.79-windows-x64.zip"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("img",{attrs:{src:"/medias/tomcat-put/1.png",alt:"1"}})]),t._v(" "),a("p",[a("img",{attrs:{src:"/medias/tomcat-put/2.png",alt:"2"}})]),t._v(" "),a("p",[t._v("在"),a("code",[t._v("conf/web.xml")]),t._v("文件里，添加必要参数"),a("code",[t._v("readonly")]),t._v("，并设置为false")]),t._v(" "),a("p",[t._v("这样，像其参数格式一样，添加到"),a("code",[t._v("<servlet>")]),t._v("标签里")]),t._v(" "),a("div",{staticClass:"language-xml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-xml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("init-param")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("param-name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("readonly"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("param-name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("param-value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("false"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("param-value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("init-param")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br")])]),a("p",[a("img",{attrs:{src:"/medias/tomcat-put/3.png",alt:"3"}})]),t._v(" "),a("p",[t._v("因为tomcat默认8080端口，burpsuite默认端口也是8080，冲突了抓不到包器，所以将tomcat的8080端口改为8081")]),t._v(" "),a("p",[t._v("在"),a("code",[t._v("conf/server.xml")]),t._v("文件里，修改端口8080为8081")]),t._v(" "),a("p",[a("img",{attrs:{src:"/medias/tomcat-put/4.png",alt:"4"}})]),t._v(" "),a("p",[t._v("在"),a("code",[t._v("bin")]),t._v("目录下，双击"),a("code",[t._v("startup.bat")]),t._v("启动tomcat")]),t._v(" "),a("p",[a("img",{attrs:{src:"/medias/tomcat-put/5.png",alt:"5"}})]),t._v(" "),a("h3",{attrs:{id:"_3-2-漏洞复现"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-漏洞复现"}},[t._v("#")]),t._v(" 3.2 漏洞复现")]),t._v(" "),a("p",[t._v("打开burpsuite自带浏览器，关闭拦截，访问"),a("code",[t._v("127.0.0.1:8081")]),t._v("，可以看到tomcat的默认首页，开启拦截，刷新页面")]),t._v(" "),a("p",[a("img",{attrs:{src:"/medias/tomcat-put/6.png",alt:"6"}})]),t._v(" "),a("p",[t._v("把这个GET请求右键，发送到"),a("code",[t._v("repeater")]),t._v("，手动修改请求方法为"),a("code",[t._v("PUT")]),t._v("，并在访问路由后面添加一个文件名参数"),a("code",[t._v("1.txt")]),t._v("，文件内容随意，测试一下")]),t._v(" "),a("p",[t._v("响应包里有"),a("code",[t._v("201 Created")]),t._v("，表示上传成功")]),t._v(" "),a("p",[a("img",{attrs:{src:"/medias/tomcat-put/7.png",alt:"7"}})]),t._v(" "),a("p",[t._v("正常访问"),a("code",[t._v("127.0.1:8081/1.txt")]),t._v("，可以看到文件内容")]),t._v(" "),a("p",[a("img",{attrs:{src:"/medias/tomcat-put/8.png",alt:"8"}})]),t._v(" "),a("h3",{attrs:{id:"_3-3-上传jsp文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-上传jsp文件"}},[t._v("#")]),t._v(" 3.3 上传jsp文件")]),t._v(" "),a("p",[t._v("在"),a("code",[t._v("repeater")]),t._v("里，接着使用"),a("code",[t._v("PUT")]),t._v("请求，把"),a("code",[t._v("1.txt")]),t._v("内容换成jsp代码，也可以正常上传，返回"),a("code",[t._v("204 No Content")]),t._v("，也表示成功上传")]),t._v(" "),a("div",{staticClass:"language-jsp line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('<%out.println("HelloWorld");%>\n')])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[a("img",{attrs:{src:"/medias/tomcat-put/9.png",alt:"9"}})]),t._v(" "),a("p",[t._v("把文件名换成"),a("code",[t._v("1.jsp")]),t._v("，接着上传，进行测试，上传失败，返回了"),a("code",[t._v("404 Not Found")]),t._v("，说明tomcat在"),a("code",[t._v("put")]),t._v("直接请求jsp时，访问了这个文件，不存在，并不会写文件")]),t._v(" "),a("p",[a("img",{attrs:{src:"/medias/tomcat-put/10.png",alt:"10"}})]),t._v(" "),a("p",[a("strong",[a("code",[t._v("/1.jsp/")]),t._v("绕过")])]),t._v(" "),a("p",[t._v("在文件名后面添加"),a("code",[t._v("/")]),t._v("，当作目录处理，可以绕过tomcat的检测，落地还是jsp文件，jsp代码可以正常解析")]),t._v(" "),a("p",[a("img",{attrs:{src:"/medias/tomcat-put/11.png",alt:"11"}})]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("提示")]),t._v(" "),a("p",[t._v("下面是一些windows平台文件上传特性，php、jsp等都适用")])]),t._v(" "),a("p",[a("strong",[t._v("windows特性：文件扩展名空格绕过")])]),t._v(" "),a("p",[t._v("在文件名后添加"),a("code",[t._v("%20")]),t._v("，windows系统不允许扩展名后有空格，会自动去除")]),t._v(" "),a("p",[a("img",{attrs:{src:"/medias/tomcat-put/12.png",alt:"12"}})]),t._v(" "),a("p",[a("strong",[t._v("windows特性：显示指定流绕过")])]),t._v(" "),a("p",[t._v("看一下微软官方文档"),a("a",{attrs:{href:"https://learn.microsoft.com/zh-cn/windows/win32/fileio/file-streams",target:"_blank",rel:"noopener noreferrer"}},[t._v("流的命名约定"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("img",{attrs:{src:"/medias/tomcat-put/13.png",alt:"13"}})]),t._v(" "),a("p",[t._v("文件名后添加"),a("code",[t._v("::$DATA")]),t._v("，表示指定流，")]),t._v(" "),a("p",[a("img",{attrs:{src:"/medias/tomcat-put/14.png",alt:"14"}})]),t._v(" "),a("p",[a("strong",[t._v("windows特性：文件名大小写不敏感绕过")])]),t._v(" "),a("p",[t._v("windows系统文件名大小写不敏感，可以绕过tomcat的检测")]),t._v(" "),a("p",[a("img",{attrs:{src:"/medias/tomcat-put/15.png",alt:"15"}})]),t._v(" "),a("p",{attrs:{color:"red"}},[t._v("上传是上传成功了，但是不解析大写的JSP")]),t._v(" "),a("p",[a("strong",[t._v("windows特性：自动去除末尾多出的点")])]),t._v(" "),a("p",[t._v("在文件名后添加"),a("code",[t._v(".")]),t._v("，windows系统会自动去除多余的点")]),t._v(" "),a("p",[a("img",{attrs:{src:"/medias/tomcat-put/16.png",alt:"16"}})]),t._v(" "),a("h2",{attrs:{id:"_4-linux环境漏洞复现"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-linux环境漏洞复现"}},[t._v("#")]),t._v(" 4. linux环境漏洞复现")]),t._v(" "),a("h3",{attrs:{id:"_4-1-环境搭建"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-环境搭建"}},[t._v("#")]),t._v(" 4.1 环境搭建")]),t._v(" "),a("p",[t._v("前置环境：")]),t._v(" "),a("ul",[a("li",[t._v("docker")]),t._v(" "),a("li",[t._v("docker-compose")]),t._v(" "),a("li",[t._v("git")])]),t._v(" "),a("p",[t._v("漏洞环境：")]),t._v(" "),a("ul",[a("li",[t._v("linux（docker）")]),t._v(" "),a("li",[t._v("tomcat 8.5.19")]),t._v(" "),a("li",[t._v("jdk 1.8")])]),t._v(" "),a("p",[t._v("使用"),a("code",[t._v("vulhub")]),t._v("提供的docker环境复现")]),t._v(" "),a("p",[t._v("前提，已经安装了git、docker和docker-compose")]),t._v(" "),a("p",[t._v("git克隆"),a("code",[t._v("vulhub")]),t._v("的整个项目")]),t._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" clone "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--depth")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" https://github.com/vulhub/vulhub\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[a("img",{attrs:{src:"/medias/tomcat-put/17.png",alt:"17"}})]),t._v(" "),a("p",[t._v("进入"),a("code",[t._v("vulhub")]),t._v("目录，找到"),a("code",[t._v("tomcat/put")]),t._v("目录，执行docker-compose命令")]),t._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" vulhub/tomcat/CVE-2017-12615\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" compose up "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-d")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br")])]),a("p",[a("img",{attrs:{src:"/medias/tomcat-put/18.png",alt:"18"}})]),t._v(" "),a("p",[t._v("访问"),a("code",[t._v("http://192.168.0.107:8080")]),t._v("，可以看到tomcat的默认首页")]),t._v(" "),a("p",[a("img",{attrs:{src:"/medias/tomcat-put/19.png",alt:"19"}})]),t._v(" "),a("h3",{attrs:{id:"_4-2-漏洞复现"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-漏洞复现"}},[t._v("#")]),t._v(" 4.2 漏洞复现")]),t._v(" "),a("p",[t._v("进入靶机shell环境，找到配置文件，"),a("code",[t._v("vulhub")]),t._v("开发者已经配置好了漏洞环境")]),t._v(" "),a("p",[a("img",{attrs:{src:"/medias/tomcat-put/22.png",alt:"22"}})]),t._v(" "),a("p",[t._v("同样是抓取一个"),a("code",[t._v("GET")]),t._v("请求，发送到"),a("code",[t._v("repeater")]),t._v("，修改请求方法为"),a("code",[t._v("PUT")]),t._v("，文件名"),a("code",[t._v("1.txt")]),t._v("，文件内容随意")]),t._v(" "),a("p",[a("img",{attrs:{src:"/medias/tomcat-put/20.png",alt:"20"}})]),t._v(" "),a("p",[t._v("返回"),a("code",[t._v("201")]),t._v("，上传成功，访问1.txt，可以看到文件内容")]),t._v(" "),a("p",[t._v("对应这个漏洞，在linux环境下，没有那么多绕过姿势，只能"),a("code",[t._v("jsp")]),t._v("文件名后添加"),a("code",[t._v("/")]),t._v("作为目录，绕过tomcat的检测，落地成jsp文件")]),t._v(" "),a("p",[a("img",{attrs:{src:"/medias/tomcat-put/21.png",alt:"21"}})]),t._v(" "),a("p",[t._v("关闭docker容器")]),t._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" compose down\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[a("img",{attrs:{src:"/medias/tomcat-put/23.png",alt:"23"}})])])}),[],!1,null,null,null);a.default=v.exports}}]);